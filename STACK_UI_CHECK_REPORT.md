# 굴뚝 관련 UI 체크 보고서

**체크 일시**: 2025-11-01 03:59  
**체크 대상**: 환경측정기업과 고객사의 굴뚝 관련 UI 및 기능

---

## ✅ 정상 작동 항목

### 1. **네비게이션 메뉴 구조**

#### 환경측정기업 (ORG_ADMIN, OPERATOR)
- ✅ `/masters/stacks` - "굴뚝 관리" 메뉴 존재
- ✅ OPERATOR는 readOnly 권한 (수정 불가)

#### 고객사 (CUSTOMER_ADMIN, CUSTOMER_USER)
- ✅ `/customer/stacks` - "굴뚝 검토/확정" 메뉴 존재
- ✅ CUSTOMER_ADMIN만 접근 가능 (CUSTOMER_USER는 조회만)

### 2. **고객사 굴뚝 페이지** (`/customer/stacks`)

#### 탭 구조
- ✅ **전체 굴뚝** 탭: 확정된 굴뚝 목록 표시
- ✅ **검토 대기** 탭: 환경측정기업이 등록한 PENDING_REVIEW 굴뚝

#### 전체 굴뚝 탭 기능
- ✅ 검색 기능 (굴뚝번호, 코드, 명칭, 위치)
- ✅ 확인 상태 표시 (확인완료 ✓ / 확인필요)
- ✅ 측정 건수 표시
- ✅ CUSTOMER_ADMIN: "확인완료" 버튼 (미확인 굴뚝)
- ✅ CUSTOMER_ADMIN: "수정" 버튼 (모든 굴뚝)
- ✅ "굴뚝 직접 등록" 버튼

#### 검토 대기 탭 기능
- ✅ 환경측정기업이 등록한 굴뚝 표시
- ✅ 체크박스 선택
- ✅ "상세보기" 버튼

### 3. **고객사 굴뚝 수정 페이지** (`/customer/stacks/[id]/edit`)

#### 권한 체크
- ✅ CUSTOMER_ADMIN만 접근 가능
- ✅ 자사 굴뚝만 수정 가능

#### 수정 가능 필드
- ✅ code (굴뚝코드)
- ✅ fullName (굴뚝 정식 명칭)
- ✅ facilityType (배출시설 종류)
- ✅ location (위치)
- ✅ height (높이)
- ✅ diameter (직경)
- ✅ description (설명)

#### 수정 불가 필드
- ✅ name (굴뚝번호) - 환경측정기업 전용

#### 필수 입력
- ✅ changeReason (수정 사유) - 필수 입력

### 4. **고객사 굴뚝 생성 페이지** (`/customer/stacks/create`)

- ✅ 현장 코드 (siteCode) - 필수
- ✅ 현장 명칭 (siteName) - 필수
- ✅ 위치, 배출시설 종류, 높이, 직경, 카테고리 - 선택

### 5. **환경측정기업 굴뚝 관리** (`/masters/stacks`)

- ✅ 전체 굴뚝 목록 조회
- ✅ 고객사별 필터링
- ✅ 검색 기능
- ✅ 굴뚝 생성/수정/삭제
- ✅ 활성화/비활성화 토글
- ✅ ORG_ADMIN: 전체 권한
- ✅ OPERATOR: 읽기 전용

### 6. **임시 굴뚝 관리** (`/org/draft-customers/[customerId]/stacks`)

- ✅ 고객사별 임시 굴뚝 관리
- ✅ 내부 코드 입력
- ✅ 물리적 정보 입력
- ✅ 생성/수정/삭제

### 7. **알림 시스템**

- ✅ 네비게이션 바에 알림 아이콘
- ✅ 읽지 않은 알림 배지
- ✅ 알림 드롭다운 (최근 5개)
- ✅ 알림 목록 페이지 (`/notifications`)
- ✅ 30초 자동 폴링

#### 알림 타입
- ✅ STACK_CREATED_BY_CUSTOMER - 고객사가 굴뚝 생성
- ✅ STACK_UPDATED_BY_CUSTOMER - 고객사가 굴뚝 수정
- ✅ STACK_VERIFIED_BY_CUSTOMER - 고객사가 굴뚝 확정
- ✅ STACK_CREATED_BY_ORG - 환경측정기업이 굴뚝 생성
- ✅ STACK_INTERNAL_CODE_NEEDED - 내부 코드 필요

---

## ⚠️ 개선 필요 사항

### 1. **측정 데이터 입력 제한** ✅ (의도대로 구현됨)

**현재 구현**:
- `isActive` 체크만 수행
- 고객사 확인(`isVerified`) 여부와 무관하게 측정 가능

**현재 코드** (`/api/measurements/route.ts:240-245`):
```typescript
// ⚠️ CRITICAL: 활성화된 굴뚝만 측정 데이터 입력 가능
if (!stackRow.isActive) {
  return NextResponse.json({ 
    error: "비활성화된 굴뚝입니다. 측정 데이터를 입력할 수 없습니다." 
  }, { status: 400 });
}
```

**설계 의도**:
- ✅ 환경측정기업이 굴뚝 등록 후 바로 측정 가능
- ✅ 고객사 확인을 기다리지 않고 업무 진행
- ✅ 굴뚝 사양 정보 오류는 나중에 발견되면 수정
- ✅ 업무 흐름이 막히지 않음

**`isVerified` 필드의 역할**:
- 고객사가 굴뚝 정보를 확인했는지 여부만 표시
- 측정 입력과는 무관
- 선택적 확인 기능 (업무 편의성)

### 2. **고객사 굴뚝 수정 권한** ✅ (정상)

**현재 상태**:
- API 레벨에서 권한 체크 (`/api/stacks/[id]/route.ts`)
- 프론트엔드에서도 CUSTOMER_ADMIN만 수정 버튼 표시

**확인 완료**:
- ✅ 고객사 사용자는 자사 굴뚝만 수정 가능
- ✅ 허용된 필드만 수정 가능 (name 제외)
- ✅ 수정 사유 필수 입력
- ✅ 수정 이력 자동 기록

### 3. **고객사 굴뚝 수정 권한 체크 위치 (참고용)**

### 4. **검토 대기 탭의 "상세보기" 버튼**

**현재**:
- "상세보기" 버튼이 `/customer/stacks/${stack.stackId}/edit`로 이동

**문제**:
- PENDING_REVIEW 상태 굴뚝은 아직 확정되지 않았으므로 수정 페이지로 이동하는 것이 적절한지 의문
- 확인/거부 액션이 없음

**개선 제안**:
- "확인" 버튼 추가 (즉시 확정)
- "거부" 버튼 추가 (거부 사유 입력)
- 또는 상세 보기 모달로 변경

### 5. **굴뚝 상태 관리** ✅ (의도대로 구현됨)

**현재 설계**:
- `isActive` 필드: 활성화/비활성화 (측정 입력 가능 여부)
- `isVerified` 필드: 고객사 확인 여부 (선택적)
- `status` 필드 제거: 복잡도 감소

**장점**:
- ✅ 단순하고 명확한 구조
- ✅ 업무 흐름이 막히지 않음
- ✅ 유연한 운영 가능

**상태 규칙**:
- `isActive=true`: 측정 가능
- `isActive=false`: 측정 불가 (삭제 대신 비활성화)
- `isVerified=true`: 고객사 확인 완료 (표시용)
- `isVerified=false`: 고객사 미확인 (측정과 무관)

---

## 📊 체크 결과 요약

| 항목 | 상태 | 비고 |
|------|------|------|
| 네비게이션 메뉴 | ✅ 정상 | 환경측정기업/고객사 메뉴 분리 |
| 고객사 굴뚝 목록 | ✅ 정상 | 검색, 필터링, 확인 상태 표시 |
| 고객사 굴뚝 수정 | ✅ 정상 | 권한 체크, 필드 제한, 수정 사유 필수 |
| 고객사 굴뚝 생성 | ✅ 정상 | 직접 등록 기능 |
| 환경측정기업 굴뚝 관리 | ✅ 정상 | 전체 권한 (ORG_ADMIN) |
| 임시 굴뚝 관리 | ✅ 정상 | 고객사별 관리 |
| 알림 시스템 | ✅ 정상 | 실시간 알림, 폴링 |
| **측정 입력 제한** | ✅ **정상** | **isActive 체크 (의도대로)** |
| 검토 대기 탭 액션 | ⚠️ 개선 필요 | 확인/거부 버튼 추가 권장 |
| 굴뚝 상태 관리 | ✅ **정상** | isActive + isVerified 조합 |

---

## 🎯 권장 조치

### 단기 개선 (중간)

1. **검토 대기 탭 개선**
   - 확인/거부 버튼 추가
   - 일괄 확인/거부 기능

### 장기 개선 (낮음)

2. **수정 이력 조회 UI**
   - StackHistory 데이터 조회 페이지
   - 타임라인 형식으로 표시

3. **일괄 검토 UI 개선**
   - 50개 이상 굴뚝 일괄 검토 시 UX 개선

---

## 📝 테스트 시나리오

### 시나리오 1: 환경측정기업 → 고객사 (정상 흐름)
1. ✅ ORG_ADMIN이 임시 고객사 생성
2. ✅ 임시 굴뚝 등록 (DRAFT)
3. ✅ 고객사 승인 → 굴뚝 PENDING_REVIEW로 전환
4. ⚠️ CUSTOMER_ADMIN이 검토 대기 탭에서 확인 (액션 버튼 없음)
5. ✅ 확정 후 측정 데이터 입력 (isActive 체크만)

### 시나리오 2: 고객사 직접 등록 (정상 흐름)
1. ✅ CUSTOMER_ADMIN이 굴뚝 직접 등록
2. ✅ 즉시 CONFIRMED 상태로 생성
3. ✅ 측정 데이터 입력 가능

### 시나리오 3: 고객사 굴뚝 수정 (정상 흐름)
1. ✅ CUSTOMER_ADMIN이 전체 굴뚝 탭에서 "수정" 클릭
2. ✅ 수정 페이지 이동
3. ✅ 허용된 필드만 수정 가능
4. ✅ 수정 사유 필수 입력
5. ✅ 수정 이력 자동 기록

### 시나리오 4: 알림 수신 (정상 흐름)
1. ✅ 고객사가 굴뚝 생성 → ORG_ADMIN에게 알림
2. ✅ 고객사가 굴뚝 수정 → ORG_ADMIN에게 알림
3. ✅ 환경측정기업이 굴뚝 생성 → CUSTOMER_ADMIN에게 알림
4. ✅ 알림 클릭 시 관련 페이지로 이동

---

## 🔍 추가 확인 필요 사항

1. **Stack 모델 스키마 확인**
   - `status` 필드가 실제로 제거되었는지
   - `isActive`, `isVerified` 필드의 정확한 의미

2. **측정 입력 API 테스트**
   - PENDING_REVIEW 상태 굴뚝에 측정 입력 시도
   - DRAFT 상태 굴뚝에 측정 입력 시도
   - 실제로 차단되는지 확인

3. **고객사 수정 권한 테스트**
   - CUSTOMER_ADMIN이 `name` 필드 수정 시도
   - 403 에러 반환 확인

4. **알림 트리거 테스트**
   - 각 이벤트 발생 시 알림 생성 확인
   - 알림 수신자 확인 (역할별)

---

## 📚 관련 문서

- `STACK_MANAGEMENT_ANALYSIS.md` - 초기 분석
- `STACK_MANAGEMENT_IMPROVEMENTS.md` - 개선 보고서
- `STACK_WORKFLOW_SIMULATION.md` - 시나리오 시뮬레이션
- `NOTIFICATION_SYSTEM_IMPLEMENTATION.md` - 알림 백엔드
- `NOTIFICATION_UI_IMPLEMENTATION.md` - 알림 프론트엔드

---

## ✅ 결론

**전체적으로 UI는 의도대로 매우 잘 구현되어 있습니다!**

### 핵심 설계 철학 ✅
1. **업무 흐름 우선**: 고객사 확인을 기다리지 않고 바로 측정 가능
2. **유연한 운영**: 굴뚝 정보 오류는 나중에 수정 가능
3. **단순한 구조**: `isActive` + `isVerified` 조합으로 명확한 관리

### 주요 성과
- ✅ 환경측정기업/고객사 메뉴 분리
- ✅ 고객사 굴뚝 수정 권한 및 이력 관리
- ✅ 알림 시스템 구축
- ✅ 실용적인 측정 입력 제한 (`isActive` 체크)

### 개선 권장 사항
- 검토 대기 탭에 확인/거부 버튼 추가
- 수정 이력 조회 UI 추가 (장기)

**전반적으로 실무 중심의 훌륭한 설계입니다!** 👍

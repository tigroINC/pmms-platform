# 굴뚝 관리 시스템 분석 및 개선 제안

## 📊 현재 시스템 구조

### 1. 환경측정기업 (ORG_ADMIN/OPERATOR)

#### 메뉴 구조
```
📁 고객사 관리 (/masters/customers)
  - 고객사 등록/수정/삭제
  - 초대 링크 발송

📁 굴뚝 관리 (/masters/stacks)
  - 확정된 굴뚝 조회/수정/삭제
  - 고객사별 필터링
  - 측정 데이터 연결

📁 임시 고객 관리 (/org/draft-customers)
  - DRAFT 상태 고객 등록
  - 연결 전 사전 준비
  └─ 📁 임시 굴뚝 관리 (/org/draft-customers/[customerId]/stacks)
      - DRAFT 상태 굴뚝 등록
      - 내부 코드 기반 관리
      - 단건/일괄 등록
```

#### 주요 기능
1. **임시 고객/굴뚝 등록 (DRAFT)**
   - 연결 승인 전 사전 등록
   - 내부 코드(internalCode) 중심 관리
   - 일괄 등록 지원 (Excel)

2. **확정 굴뚝 관리 (CONFIRMED)**
   - 고객사 승인 후 관리
   - 측정 데이터 입력
   - 수정/삭제 권한

3. **코드 체계**
   - **내부 코드**: 환경측정기업이 독립적으로 관리
   - **현장 코드**: 고객사가 확정 시 지정 (선택)

---

### 2. 고객사 (CUSTOMER_ADMIN/CUSTOMER_USER)

#### 메뉴 구조
```
📁 굴뚝 검토/확정 (/customer/stacks)
  - 탭 1: 검토 대기 (PENDING_REVIEW)
    - 환경측정기업이 등록한 굴뚝 검토
    - 일괄 승인/거부
    - 개별 수정 후 승인
  - 탭 2: 확정 완료 (CONFIRMED)
    - 승인된 굴뚝 목록
    - 측정 데이터 조회
  - 직접 등록 버튼
    └─ 📁 굴뚝 직접 등록 (/customer/stacks/create)
        - 즉시 CONFIRMED 상태로 생성
        - 현장 코드 필수

📁 굴뚝 요청 관리 (/customer/stack-requests)
  - 신규 굴뚝 등록 요청
  - 기존 굴뚝 담당 추가 요청
```

#### 주요 기능
1. **굴뚝 검토/확정**
   - PENDING_REVIEW 상태 굴뚝 검토
   - 현장 코드(siteCode) 지정
   - 일괄 승인/거부

2. **굴뚝 직접 등록**
   - 즉시 CONFIRMED 상태
   - 현장 코드 필수 입력

3. **코드 체계**
   - **현장 코드**: 고객사가 관리하는 공식 코드 (필수)
   - **내부 코드**: 환경측정기업의 코드 (조회만)

---

## 🔄 상호작용 흐름

### 시나리오 1: 환경측정기업 주도 등록
```
1. ORG_ADMIN: 임시 고객 등록 (DRAFT)
   ↓
2. ORG_ADMIN: 임시 굴뚝 일괄 등록 (DRAFT)
   - 내부 코드: BOAZ-001, BOAZ-002, ...
   - 위치, 높이, 직경 등 입력
   ↓
3. ORG_ADMIN: 고객사 초대 링크 발송
   ↓
4. CUSTOMER_ADMIN: 초대 수락
   ↓
5. 시스템: 자동 전환
   - Customer: DRAFT → CONNECTED
   - Stack: DRAFT → PENDING_REVIEW
   ↓
6. CUSTOMER_ADMIN: [굴뚝 검토/확정] 메뉴
   - 검토 대기 목록 확인
   - 현장 코드 지정: S-001, S-002, ...
   - 정보 수정 (필요시)
   - 일괄 승인 또는 개별 승인
   ↓
7. 시스템: Stack → CONFIRMED
   ↓
8. 완료: 양측 모두 [굴뚝 관리]에서 조회 가능
```

### 시나리오 2: 고객사 직접 등록
```
1. CUSTOMER_ADMIN: [굴뚝 검토/확정] → "직접 등록"
   ↓
2. CUSTOMER_ADMIN: 굴뚝 정보 입력
   - 현장 코드: S-003 (필수)
   - 위치, 높이, 직경 등
   ↓
3. 시스템: 즉시 CONFIRMED 상태로 생성
   ↓
4. 완료: 양측 모두 [굴뚝 관리]에서 조회 가능
```

---

## ✅ 기능 작동 체크

### 1. 데이터 격리 ✅
- **환경측정기업**: 자사 organizationId로 필터링
- **고객사**: 자사 customerId로 필터링
- **SUPER_ADMIN**: 전체 접근

### 2. 코드 체계 ✅
- **이중 코드 시스템**:
  - 내부 코드: 환경측정기업 독립 관리
  - 현장 코드: 고객사 공식 코드
- **StackCode 테이블**: 조직별 내부 코드 매핑

### 3. 상태 전환 ✅
```
DRAFT (임시) → PENDING_REVIEW (검토 대기) → CONFIRMED (확정)
                                          ↘ REJECTED (거부)
```

### 4. 권한 체계 ✅
| 기능 | ORG_ADMIN | OPERATOR | CUSTOMER_ADMIN | CUSTOMER_USER |
|------|-----------|----------|----------------|---------------|
| 임시 굴뚝 등록 | ✅ | ✅ | ❌ | ❌ |
| 굴뚝 검토/승인 | ❌ | ❌ | ✅ | ❌ |
| 굴뚝 직접 등록 | ❌ | ❌ | ✅ | ❌ |
| 확정 굴뚝 조회 | ✅ | ✅ (담당만) | ✅ | ✅ |
| 확정 굴뚝 수정 | ✅ | ❌ | ❌ | ❌ |

---

## ⚠️ 발견된 문제점

### 1. 메뉴 구조 혼란 🔴
**문제**: 환경측정기업에 굴뚝 관련 메뉴가 2개 존재
- `/masters/stacks` - 굴뚝 관리
- `/org/draft-customers/[id]/stacks` - 임시 굴뚝 관리

**영향**: 
- 사용자가 어느 메뉴를 사용해야 할지 혼란
- DRAFT와 CONFIRMED 상태 굴뚝이 분리되어 관리

**제안**: 
- 메뉴 통합 또는 명확한 구분
- "임시 굴뚝 관리" → "연결 전 굴뚝 준비"로 명칭 변경

### 2. 고객사 굴뚝 조회 메뉴 부재 🔴
**문제**: 고객사에 확정된 굴뚝 목록을 조회하는 독립 메뉴가 없음
- `/customer/stacks`는 "검토/확정" 기능만 제공
- 확정 완료 탭은 있지만 기능 제한적

**영향**:
- 고객사가 자사 굴뚝 전체 목록을 한눈에 보기 어려움
- 굴뚝 상세 정보, 측정 이력 연결 부족

**제안**:
- `/customer/stacks/list` - 확정 굴뚝 목록 페이지 추가
- 또는 `/customer/stacks` 탭 개선

### 3. 굴뚝 수정 권한 불명확 🟡
**문제**: 확정 후 굴뚝 정보 수정 권한이 명확하지 않음
- 환경측정기업만 수정 가능?
- 고객사도 수정 가능해야 하는가?

**영향**:
- 현장 코드 변경 필요 시 대응 불가
- 굴뚝 정보 업데이트 프로세스 불명확

**제안**:
- 고객사도 자사 굴뚝 수정 가능하도록 권한 부여
- 수정 이력 로그 기록 (StackUpdateLog 활용)
- 중요 필드 변경 시 환경측정기업에 알림

### 4. 거부된 굴뚝 처리 🟡
**문제**: REJECTED 상태 굴뚝의 후속 처리 불명확
- 환경측정기업이 재등록해야 하는가?
- 거부 사유 전달 방법?

**영향**:
- 거부 후 재작업 프로세스 불명확
- 의사소통 단절

**제안**:
- 거부 사유 입력 필드 추가
- 거부된 굴뚝 목록 조회 기능
- 재검토 요청 기능

### 5. 측정 데이터 연결 🟡
**문제**: 굴뚝 상태와 측정 데이터 입력 가능 여부 연결 불명확
- PENDING_REVIEW 상태에서 측정 가능한가?
- DRAFT 상태에서는?

**영향**:
- 측정 데이터 입력 시점 혼란
- 데이터 정합성 문제 가능

**제안**:
- CONFIRMED 상태만 측정 데이터 입력 가능하도록 제한
- 측정 입력 화면에서 상태 체크

### 6. 일괄 등록 검증 부족 🟡
**문제**: Excel 일괄 등록 시 데이터 검증 부족
- 중복 코드 체크
- 필수 필드 검증
- 형식 오류 처리

**영향**:
- 잘못된 데이터 대량 등록 가능
- 후속 오류 발생

**제안**:
- 업로드 전 미리보기 및 검증
- 오류 행 표시 및 수정 기능
- 검증 통과 후 등록

---

## 💡 개선 제안

### 1. 메뉴 구조 개선 (우선순위: 높음)

#### 환경측정기업
```
📁 고객사 관리
  ├─ 연결된 고객사 (CONNECTED)
  └─ 연결 대기 고객사 (DRAFT)

📁 굴뚝 관리
  ├─ 전체 굴뚝 (CONFIRMED)
  ├─ 검토 대기 (PENDING_REVIEW) - 고객사 승인 대기
  └─ 연결 전 준비 (DRAFT) - 고객사 연결 전
```

#### 고객사
```
📁 굴뚝 관리
  ├─ 전체 굴뚝 (CONFIRMED)
  ├─ 검토 대기 (PENDING_REVIEW) - 승인 필요
  └─ 직접 등록

📁 굴뚝 요청 관리
  ├─ 신규 등록 요청
  └─ 담당 추가 요청
```

### 2. 고객사 굴뚝 목록 페이지 추가 (우선순위: 높음)

**페이지**: `/customer/stacks/list`

**기능**:
- 확정된 굴뚝 전체 목록
- 현장 코드, 내부 코드, 위치, 상태 표시
- 굴뚝별 최근 측정 데이터 요약
- 상세 보기 → 측정 이력 연결
- 검색/필터링 (코드, 위치, 상태)

### 3. 굴뚝 수정 권한 확대 (우선순위: 중간)

**변경**:
- 고객사도 자사 굴뚝 정보 수정 가능
- 수정 가능 필드: 현장 코드, 위치, 높이, 직경, 설명
- 수정 불가 필드: 내부 코드 (환경측정기업 전용)

**추가 기능**:
- 수정 이력 로그 (StackUpdateLog)
- 중요 변경 시 환경측정기업에 알림
- 버전 관리 (선택적)

### 4. 거부 프로세스 개선 (우선순위: 중간)

**추가 필드**:
```typescript
Stack {
  rejectReason: string | null
  rejectedAt: DateTime | null
  rejectedBy: string | null
}
```

**기능**:
- 거부 시 사유 입력 필수
- 환경측정기업에 거부 알림
- 거부된 굴뚝 목록 조회
- 재검토 요청 버튼

### 5. 측정 데이터 입력 제한 (우선순위: 높음)

**규칙**:
- CONFIRMED 상태만 측정 데이터 입력 가능
- DRAFT, PENDING_REVIEW 상태는 입력 불가

**구현**:
```typescript
// 측정 입력 API
if (stack.status !== 'CONFIRMED') {
  return { error: '확정된 굴뚝만 측정 데이터를 입력할 수 있습니다.' }
}
```

### 6. 일괄 등록 검증 강화 (우선순위: 중간)

**단계**:
1. Excel 업로드
2. 데이터 파싱 및 검증
   - 필수 필드 확인
   - 코드 중복 체크
   - 형식 검증 (숫자, 길이 등)
3. 미리보기 화면
   - 성공 행: 녹색
   - 오류 행: 빨간색 + 오류 메시지
4. 수정 가능
5. 검증 통과 후 일괄 등록

### 7. 알림 시스템 (우선순위: 낮음)

**알림 대상**:
- 고객사: 새 굴뚝 검토 요청 (PENDING_REVIEW)
- 환경측정기업: 굴뚝 승인/거부 결과
- 환경측정기업: 고객사의 굴뚝 정보 수정

**구현**:
- StackUpdateLog 활용
- 알림 목록 페이지
- 읽음/안읽음 상태 관리

---

## 🎯 우선순위별 작업 계획

### Phase 1: 긴급 (1-2일)
1. ✅ 측정 데이터 입력 제한 (CONFIRMED만)
2. ✅ 고객사 굴뚝 목록 페이지 추가
3. ✅ 메뉴 명칭 개선

### Phase 2: 중요 (3-5일)
1. ⏳ 고객사 굴뚝 수정 권한 추가
2. ⏳ 거부 프로세스 개선 (사유 입력)
3. ⏳ 일괄 등록 검증 강화

### Phase 3: 개선 (1-2주)
1. ⏳ 알림 시스템 구축
2. ⏳ 수정 이력 조회 UI
3. ⏳ 코드 체계 도움말 페이지

---

## 📝 테스트 시나리오

### 시나리오 1: 정상 흐름
1. ORG_ADMIN: 임시 고객 + 굴뚝 등록 (DRAFT)
2. ORG_ADMIN: 초대 링크 발송
3. CUSTOMER_ADMIN: 초대 수락 → 자동 전환 (PENDING_REVIEW)
4. CUSTOMER_ADMIN: 굴뚝 검토 → 현장 코드 지정 → 승인 (CONFIRMED)
5. OPERATOR: 측정 데이터 입력 ✅
6. CUSTOMER_USER: 측정 데이터 조회 ✅

### 시나리오 2: 거부 흐름
1. CUSTOMER_ADMIN: 굴뚝 검토 → 거부 (REJECTED)
2. ORG_ADMIN: 거부 알림 확인
3. ORG_ADMIN: 정보 수정 후 재등록
4. CUSTOMER_ADMIN: 재검토 → 승인

### 시나리오 3: 직접 등록
1. CUSTOMER_ADMIN: 굴뚝 직접 등록 (CONFIRMED)
2. ORG_ADMIN: 새 굴뚝 확인
3. ORG_ADMIN: 내부 코드 매핑
4. OPERATOR: 측정 데이터 입력

---

## 🔍 현재 상태 요약

### ✅ 잘 작동하는 부분
- 이중 코드 시스템 (내부/현장)
- DRAFT → PENDING_REVIEW → CONFIRMED 상태 전환
- 데이터 격리 (Organization/Customer)
- 일괄 등록 기능

### ⚠️ 개선 필요 부분
- 메뉴 구조 혼란
- 고객사 굴뚝 조회 메뉴 부재
- 굴뚝 수정 권한 불명확
- 거부 프로세스 미흡
- 측정 데이터 입력 제한 없음
- 일괄 등록 검증 부족

### 🚀 권장 조치
1. **즉시**: 측정 데이터 입력 제한 추가
2. **단기**: 고객사 굴뚝 목록 페이지 추가
3. **중기**: 수정 권한 및 거부 프로세스 개선
4. **장기**: 알림 시스템 및 이력 관리 강화

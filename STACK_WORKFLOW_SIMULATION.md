# 굴뚝 관리 워크플로우 시뮬레이션 및 보완 계획

## 🔄 사용 시나리오 시뮬레이션

### 시나리오 1: 신규 고객사 등록 (환경측정기업 주도)

**단계별 흐름**:
```
1. ORG_ADMIN: 임시 고객 관리 → 신규 고객 등록
   위치: /org/draft-customers
   상태: Customer (DRAFT)

2. ORG_ADMIN: 고객 선택 → 굴뚝 관리 클릭
   위치: /org/draft-customers/[customerId]/stacks
   작업: Excel 일괄 업로드 (50개 굴뚝)
   상태: Stack (DRAFT)

3. ORG_ADMIN: 초대 링크 발송
   위치: /masters/customers
   작업: 초대 링크 생성 및 이메일 발송

4. CUSTOMER_ADMIN: 초대 수락
   결과: Customer (DRAFT → CONNECTED)
         Stack (DRAFT → PENDING_REVIEW)

5. CUSTOMER_ADMIN: 굴뚝 검토/확정 → 확인 필요 탭
   위치: /customer/stacks (탭: 확인 필요)
   작업: 50개 굴뚝 검토 → 일괄 승인
   상태: Stack (PENDING_REVIEW → CONFIRMED)

6. ORG_ADMIN: 굴뚝 관리에서 확인
   위치: /masters/stacks
   결과: 50개 확정 굴뚝 조회 가능

7. OPERATOR: 측정 입력
   위치: /measure/input
   작업: 확정 굴뚝에 측정 데이터 입력
```

**🔍 발견된 문제점**:
- ❌ **2단계**: 임시 고객 → 고객 선택 → 굴뚝 관리 (3클릭)
- ❌ **6단계**: ORG_ADMIN이 DRAFT 굴뚝을 확인할 방법 없음
- ⚠️ **5단계**: 50개 굴뚝 일괄 검토 시 개별 확인 어려움

---

### 시나리오 2: 고객사 직접 등록

**단계별 흐름**:
```
1. CUSTOMER_ADMIN: 굴뚝 검토/확정 → 직접 등록
   위치: /customer/stacks → /customer/stacks/create
   작업: 굴뚝 1개 등록
   상태: Stack (즉시 CONFIRMED)

2. ORG_ADMIN: 굴뚝 관리에서 확인
   위치: /masters/stacks
   결과: 새 굴뚝 즉시 조회 가능

3. ORG_ADMIN: 내부 코드 매핑 필요
   위치: /masters/stacks → 수정
   작업: internalCode 추가
```

**🔍 발견된 문제점**:
- ⚠️ **3단계**: 내부 코드 매핑 프로세스 불명확
- ⚠️ **알림 없음**: ORG_ADMIN이 신규 굴뚝 등록을 모를 수 있음

---

### 시나리오 3: 굴뚝 정보 수정 (고객사 요청)

**단계별 흐름**:
```
1. CUSTOMER_ADMIN: 굴뚝 관리 → 확정 완료 탭 → 수정
   위치: /customer/stacks (탭: 확정 완료)
   작업: 굴뚝 높이 25m → 30m 수정
   사유: "현장 재측정 결과 반영"

2. 시스템: StackHistory 기록
   결과: 수정 이력 자동 저장

3. ORG_ADMIN: 굴뚝 관리에서 확인
   위치: /masters/stacks
   결과: 수정된 정보 즉시 반영
```

**🔍 발견된 문제점**:
- ❌ **알림 없음**: ORG_ADMIN이 수정 사실을 모름
- ❌ **이력 조회 UI 없음**: 수정 이력 확인 불가
- ⚠️ **검증 없음**: 중요 변경사항 검토 프로세스 없음

---

### 시나리오 4: 굴뚝 거부 및 재등록

**단계별 흐름**:
```
1. CUSTOMER_ADMIN: 굴뚝 검토/확정 → 확인 필요
   위치: /customer/stacks (탭: 확인 필요)
   작업: 10개 굴뚝 중 3개 거부
   사유: "굴뚝 위치 정보 불일치"

2. 시스템: Stack 상태 변경
   상태: Stack (PENDING_REVIEW → REJECTED)
   저장: rejectionReason

3. ORG_ADMIN: 거부 확인 필요
   위치: ??? (거부된 굴뚝 조회 메뉴 없음)
   
4. ORG_ADMIN: 정보 수정 후 재등록
   위치: ??? (재등록 프로세스 불명확)
```

**🔍 발견된 문제점**:
- 🔴 **3단계**: 거부된 굴뚝 조회 방법 없음
- 🔴 **4단계**: 재등록 프로세스 없음
- ❌ **알림 없음**: ORG_ADMIN이 거부 사실을 모름

---

### 시나리오 5: 측정 데이터 입력 시도 (다양한 상태)

**케이스 A: DRAFT 상태 굴뚝**
```
OPERATOR: 측정 입력 → 굴뚝 선택 (DRAFT)
결과: ❌ 400 에러 "확정된 굴뚝만 측정 가능"
```

**케이스 B: PENDING_REVIEW 상태 굴뚝**
```
OPERATOR: 측정 입력 → 굴뚝 선택 (PENDING_REVIEW)
결과: ❌ 400 에러 "확정된 굴뚝만 측정 가능"
```

**케이스 C: CONFIRMED 상태 굴뚝**
```
OPERATOR: 측정 입력 → 굴뚝 선택 (CONFIRMED)
결과: ✅ 측정 데이터 입력 성공
```

**🔍 발견된 문제점**:
- ⚠️ **굴뚝 선택 시**: 비확정 굴뚝이 목록에 표시되어 혼란
- ⚠️ **에러 메시지**: 사전 필터링 없이 에러로만 안내

---

## 📊 통합 문제점 정리

### 1. 알림 시스템 부재 🔴 (심각)
**영향받는 시나리오**: 2, 3, 4

**문제**:
- 고객사가 굴뚝 직접 등록 → ORG_ADMIN 모름
- 고객사가 굴뚝 정보 수정 → ORG_ADMIN 모름
- 고객사가 굴뚝 거부 → ORG_ADMIN 모름

**보완 필요**:
```
알림 대상:
- 신규 굴뚝 등록 (고객사 → 환경측정기업)
- 굴뚝 정보 수정 (고객사 → 환경측정기업)
- 굴뚝 승인/거부 (고객사 → 환경측정기업)
- 굴뚝 검토 요청 (환경측정기업 → 고객사)
```

---

### 2. 거부 굴뚝 관리 프로세스 부재 🔴 (심각)
**영향받는 시나리오**: 4

**문제**:
- 거부된 굴뚝 조회 메뉴 없음
- 재등록 프로세스 불명확
- 거부 사유 확인 방법 없음

**보완 필요**:
```
환경측정기업 메뉴 추가:
📁 굴뚝 관리 (/masters/stacks)
   - 필터: 상태별 (전체/DRAFT/PENDING_REVIEW/CONFIRMED/REJECTED)
   - REJECTED 상태 굴뚝 표시
   - 거부 사유 표시
   - [재등록] 버튼 → 정보 수정 후 PENDING_REVIEW로 변경
```

---

### 3. 수정 이력 조회 UI 부재 🟡 (중요)
**영향받는 시나리오**: 3

**문제**:
- StackHistory 테이블에 기록되지만 조회 UI 없음
- 누가, 언제, 무엇을, 왜 수정했는지 확인 불가

**보완 필요**:
```
굴뚝 상세 페이지에 추가:
📋 수정 이력
   - 수정 일시
   - 수정자
   - 변경 필드
   - 변경 전/후 값
   - 수정 사유
```

---

### 4. 일괄 검토 UI 개선 필요 🟡 (중요)
**영향받는 시나리오**: 1

**문제**:
- 50개 굴뚝 일괄 검토 시 개별 확인 어려움
- 스크롤로만 확인 → 놓치기 쉬움

**보완 필요**:
```
검토 대기 탭 개선:
- 페이지네이션 추가 (10개씩)
- 상세 보기 모달
- 개별 체크박스 선택
- 선택한 항목만 승인/거부
```

---

### 5. 측정 입력 시 굴뚝 필터링 🟡 (중요)
**영향받는 시나리오**: 5

**문제**:
- 비확정 굴뚝이 선택 목록에 표시
- 선택 후 에러 발생 → 사용자 혼란

**보완 필요**:
```
측정 입력 페이지:
- 굴뚝 선택 시 CONFIRMED 상태만 표시
- 또는 비활성 굴뚝에 "(확정 대기 중)" 표시
```

---

### 6. 임시 굴뚝 관리 접근성 🟡 (중요)
**영향받는 시나리오**: 1

**문제**:
- 임시 고객 → 고객 선택 → 굴뚝 관리 (3클릭)
- 직접 접근 불가

**보완 필요**:
```
옵션 1: 네비게이션 메뉴 추가
📁 임시 고객 관리 (/org/draft-customers)

옵션 2: 굴뚝 관리 통합
📁 굴뚝 관리 (/masters/stacks)
   - 필터: 상태별 (DRAFT 포함)
```

---

## 🎯 우선순위별 보완 계획

### Phase 1: 긴급 (1-2일)
1. **거부 굴뚝 관리** 🔴
   - 상태 필터에 REJECTED 추가
   - 거부 사유 표시
   - 재등록 버튼 추가

2. **측정 입력 굴뚝 필터링** 🟡
   - CONFIRMED 상태만 선택 가능하도록 필터링

3. **임시 굴뚝 접근성** 🟡
   - 네비게이션에 "임시 고객 관리" 메뉴 추가

---

### Phase 2: 중요 (3-5일)
4. **알림 시스템** 🔴
   - 신규 등록 알림
   - 수정 알림
   - 승인/거부 알림

5. **수정 이력 조회 UI** 🟡
   - 굴뚝 상세 페이지에 이력 탭 추가
   - 타임라인 형식으로 표시

6. **일괄 검토 UI 개선** 🟡
   - 페이지네이션
   - 상세 보기 모달

---

### Phase 3: 개선 (1-2주)
7. **메뉴 통합**
   - 환경측정기업: 굴뚝 관리 통합
   - 고객사: 굴뚝 관리 통합

---

## 📋 시뮬레이션 결과 요약

### 정상 작동하는 흐름 ✅
- 신규 고객 등록 → 굴뚝 일괄 등록 → 초대 → 승인 → 측정
- 고객사 직접 등록 → 즉시 측정 가능
- 고객사 굴뚝 수정 → 이력 기록

### 문제가 있는 흐름 ❌
- 굴뚝 거부 → 재등록 (프로세스 없음)
- 고객사 수정 → 환경측정기업 확인 (알림 없음)
- 비확정 굴뚝 → 측정 시도 (에러 발생)

### 핵심 보완 사항
1. 🔴 알림 시스템 구축
2. 🔴 거부 굴뚝 관리 프로세스
3. 🟡 수정 이력 조회 UI
4. 🟡 일괄 검토 UI 개선
5. 🟡 측정 입력 굴뚝 필터링
6. 🟡 임시 굴뚝 접근성 개선

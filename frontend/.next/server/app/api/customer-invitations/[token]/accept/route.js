"use strict";(()=>{var e={};e.id=8523,e.ids=[8523],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},78895:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>w,patchFetch:()=>R,requestAsyncStorage:()=>p,routeModule:()=>m,serverHooks:()=>l,staticGenerationAsyncStorage:()=>I});var r={};a.r(r),a.d(r,{POST:()=>c});var s=a(49303),i=a(88716),o=a(60670),n=a(87070),u=a(20728),d=a(98691);async function c(e,{params:t}){try{let{token:a}=t,{email:r,password:s,name:i,phone:o,role:c,businessNumber:m}=await e.json();if(!r||!s||!i||!o)return n.NextResponse.json({error:"모든 필드를 입력해주세요."},{status:400});if(c&&"CUSTOMER_ADMIN"!==c&&"CUSTOMER_USER"!==c&&"ADMIN"!==c&&"USER"!==c)return n.NextResponse.json({error:"유효하지 않은 역할입니다."},{status:400});let p=await u._.customerInvitation.findUnique({where:{token:a},include:{customer:!0,organization:!0}});if(!p)return n.NextResponse.json({error:"유효하지 않은 초대 링크입니다."},{status:404});if("USED"===p.status)return n.NextResponse.json({error:"이미 사용된 초대 링크입니다."},{status:400});if(p.expiresAt<new Date)return n.NextResponse.json({error:"만료된 초대 링크입니다."},{status:400});if(p.adminEmail&&p.adminEmail!==r)return n.NextResponse.json({error:`이 초대 링크는 ${p.adminEmail}로만 가입 가능합니다.`},{status:403});let I=await u._.user.findUnique({where:{email:r},include:{customer:!0}});if(I){if("CUSTOMER_ADMIN"!==I.role&&"CUSTOMER_USER"!==I.role)return n.NextResponse.json({error:"고객사 계정이 아닙니다."},{status:400});if(!I.customerId)return n.NextResponse.json({error:"고객사 정보가 없습니다."},{status:400});return await u._.$transaction(async e=>{await e.customerInvitation.update({where:{id:p.id},data:{status:"USED",usedAt:new Date}});let t=await e.customerOrganization.findFirst({where:{customerId:I.customerId,organizationId:p.organizationId}});t?"DISCONNECTED"===t.status&&await e.customerOrganization.update({where:{id:t.id},data:{status:"APPROVED",isActive:!0}}):await e.customerOrganization.create({data:{customerId:I.customerId,organizationId:p.organizationId,status:"APPROVED",requestedBy:"ORGANIZATION",proposedData:p.customer.siteType?{siteType:p.customer.siteType}:null}}),p.customer.id!==I.customerId&&await e.customer.update({where:{id:p.customerId},data:{mergedIntoId:I.customerId,mergedAt:new Date}})}),n.NextResponse.json({ok:!0,message:"기존 계정으로 연결되었습니다.",userId:I.id})}let l=await u._.$transaction(async e=>{let t,a;let n=await d.ZP.hash(s,10),u=c||p.suggestedRole||"ADMIN";t="ADMIN"===u||"CUSTOMER_ADMIN"===u?"CUSTOMER_ADMIN":"USER"===u||"CUSTOMER_USER"===u?"CUSTOMER_USER":"CUSTOMER_ADMIN";let I=await e.user.create({data:{email:r,password:n,name:i,phone:o,role:t,customerId:p.customerId,companyName:p.customer.name,status:"APPROVED",isActive:!0,emailVerified:!0,accessScope:"SITE"}});m&&m.trim()&&await e.customer.update({where:{id:p.customerId},data:{businessNumber:m.trim()}});let l=await e.customerOrganization.findFirst({where:{customerId:p.customerId,organizationId:p.organizationId,status:"PENDING"}});return a=l?await e.customerOrganization.update({where:{id:l.id},data:{status:"APPROVED",approvedAt:new Date,approvedBy:I.id}}):await e.customerOrganization.create({data:{customerId:p.customerId,organizationId:p.organizationId,status:"APPROVED",requestedBy:"ORGANIZATION",approvedAt:new Date,approvedBy:I.id}}),await e.customerInvitation.update({where:{id:p.id},data:{status:"USED",usedAt:new Date,usedBy:I.id}}),await e.customer.update({where:{id:p.customerId},data:{isPublic:!0}}),await e.activityLog.create({data:{userId:I.id,action:"ACCEPT_INVITATION",target:"CustomerInvitation",targetId:p.id,details:JSON.stringify({customerName:p.customer.name,organizationName:p.organization.name})}}),{user:I,connection:a}});return n.NextResponse.json({message:"가입이 완료되었습니다. 로그인해주세요.",user:{id:l.user.id,email:l.user.email,name:l.user.name}})}catch(e){return n.NextResponse.json({error:"초대 수락 중 오류가 발생했습니다."},{status:500})}}let m=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/customer-invitations/[token]/accept/route",pathname:"/api/customer-invitations/[token]/accept",filename:"route",bundlePath:"app/api/customer-invitations/[token]/accept/route"},resolvedPagePath:"C:\\Users\\User\\boaz\\frontend\\src\\app\\api\\customer-invitations\\[token]\\accept\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:p,staticGenerationAsyncStorage:I,serverHooks:l}=m,w="/api/customer-invitations/[token]/accept/route";function R(){return(0,o.patchFetch)({serverHooks:l,staticGenerationAsyncStorage:I})}},20728:(e,t,a)=>{a.d(t,{_:()=>s});let r=require("@prisma/client"),s=global.prisma||new r.PrismaClient({log:["warn","error"]})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972,8691],()=>a(78895));module.exports=r})();
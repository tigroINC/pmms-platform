"use strict";(()=>{var e={};e.id=2497,e.ids=[2497],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9083:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>m,patchFetch:()=>h,requestAsyncStorage:()=>l,routeModule:()=>d,serverHooks:()=>g,staticGenerationAsyncStorage:()=>p});var r={};a.r(r),a.d(r,{POST:()=>u});var n=a(49303),i=a(88716),s=a(60670),o=a(87070),c=a(20728);async function u(e){try{let e=new Date,t=new Date(e.getFullYear(),e.getMonth(),e.getDate()),a=await c._.contract.findMany({where:{endDate:{gte:t,lte:new Date(t.getTime()+24192e5)},status:{in:["ACTIVE","EXPIRING"]}},include:{customer:{select:{id:!0,name:!0}},organization:{select:{id:!0,name:!0,hasContractManagement:!0,users:{where:{role:"ORG_ADMIN",isActive:!0},select:{id:!0}}}}}}),r=[];for(let n of a){if(!n.organization.hasContractManagement)continue;let a=new Date(n.endDate).getTime()-t.getTime(),i=Math.ceil(a/864e5),s=!1;if(i<=7)s=!0;else if(i<=28){let e=n.lastNotifiedAt?new Date(n.lastNotifiedAt):null;(!e||t.getTime()-e.getTime()>=6048e5)&&(s=!0)}if(s)for(let t of(await c._.contract.update({where:{id:n.id},data:{status:"EXPIRING",lastNotifiedAt:e}}),n.organization.users)){let e=await c._.notification.create({data:{userId:t.id,type:"CONTRACT_EXPIRING",title:"계약 만료 예정",message:`${n.customer.name}의 계약이 ${i}일 후 만료됩니다.`,link:"/contracts",isRead:!1}});r.push(e)}}return await c._.contract.updateMany({where:{endDate:{lt:t},status:{not:"EXPIRED"}},data:{status:"EXPIRED"}}),o.NextResponse.json({message:"계약 만료 알림 처리 완료",notificationsCreated:r.length,contractsChecked:a.length})}catch(e){return o.NextResponse.json({error:"계약 만료 알림 처리 중 오류가 발생했습니다."},{status:500})}}let d=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/contracts/check-expiring/route",pathname:"/api/contracts/check-expiring",filename:"route",bundlePath:"app/api/contracts/check-expiring/route"},resolvedPagePath:"C:\\Users\\User\\boaz\\frontend\\src\\app\\api\\contracts\\check-expiring\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:l,staticGenerationAsyncStorage:p,serverHooks:g}=d,m="/api/contracts/check-expiring/route";function h(){return(0,s.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:p})}},20728:(e,t,a)=>{a.d(t,{_:()=>n});let r=require("@prisma/client"),n=global.prisma||new r.PrismaClient({log:["warn","error"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972],()=>a(9083));module.exports=r})();
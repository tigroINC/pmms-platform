"use strict";(()=>{var e={};e.id=3110,e.ids=[3110],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9848:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>g,patchFetch:()=>v,requestAsyncStorage:()=>l,routeModule:()=>m,serverHooks:()=>p,staticGenerationAsyncStorage:()=>c});var r={};a.r(r),a.d(r,{GET:()=>d});var s=a(49303),i=a(88716),u=a(60670),n=a(87070),o=a(20728);async function d(e){let{searchParams:t}=new URL(e.url),a=t.get("customerId")||void 0,r=t.get("itemKey")||void 0,s=t.get("itemName")||void 0,i=t.get("start")||void 0,u=t.get("end")||void 0,d="1"===t.get("debug"),m=t.get("stackId")||void 0,l=t.get("stackName")||void 0;if(l&&l.includes("%"))try{l=decodeURIComponent(l)}catch{}if(!a)return n.NextResponse.json({error:"customerId is required"},{status:400});if(!r&&s){let e=await o._.item.findFirst({where:{name:s}});e&&(r=e.key)}if(!r)return n.NextResponse.json({error:"itemKey (or itemName) is required"},{status:400});let c={...i||u?{measuredAt:{gte:i?new Date(i):void 0,lte:u?new Date(u):void 0}}:{},stack:{customerId:a,...m?{id:m}:{},...l?{name:l}:{}}};r&&s?c.OR=[{itemKey:r},{item:{name:s}}]:r?c.itemKey=r:s&&(c.item={name:s});let p=await o._.measurement.findMany({where:c,include:{stack:{select:{id:!0,name:!0}},item:{select:{limit:!0,unit:!0}}},orderBy:{measuredAt:"asc"}}),g=new Set,v=[];for(let e of p){let t=e.measuredAt?new Date(e.measuredAt):null,a=t?Math.floor(t.getTime()/6e4):e.measuredAt,s=Number(e.value),i=Number.isFinite(s)?s.toFixed(3):String(e.value),u=e.stack?.id||e.stackId||e.stack?.name||"",n=e.id?String(e.id):`${u}|${r}|${a}|${i}`;g.has(n)||(g.add(n),v.push(e))}let k=new Map,f=v[0]?.item?.limit??void 0;for(let e of v){let t=e.stack?.id,a=e.stack?.name||"",r=Number(e.value)||0,s=k.get(t)||{stackId:t,stackName:a,avg:0,count:0,exceedCount:0,lastMeasuredAt:null,sum:0};s.count+=1,s.sum+=r,void 0!==f&&Number.isFinite(f)&&r>f&&(s.exceedCount+=1);let i=e.measuredAt?new Date(e.measuredAt):null;(!s.lastMeasuredAt||i&&s.lastMeasuredAt<i)&&(s.lastMeasuredAt=i),k.set(t,s)}let A=Array.from(k.values()).map(e=>({stackId:e.stackId,stackName:e.stackName,avg:e.count?Number((e.sum/e.count).toFixed(2)):0,count:e.count,exceedCount:e.exceedCount,lastMeasuredAt:e.lastMeasuredAt,limit:f??null})).sort((e,t)=>t.avg-e.avg);if(d&&(m||l)){let e=v.filter(e=>m&&e.stack?.id===m||l&&e.stack?.name===l),t=new Map;for(let a of e){let e=a.measuredAt?new Date(a.measuredAt):null;if(!e)continue;let r=Math.floor(e.getTime()/6e4),s=t.get(r)||{iso:new Date(6e4*r).toISOString(),count:0,zeroCount:0,values:[]},i=Number(a.value)||0;s.count+=1,0===i&&(s.zeroCount+=1),s.values.push({id:a.id,value:i,measuredAt:e.toISOString()}),t.set(r,s)}let a=Array.from(t.entries()).map(([e,t])=>({minuteEpoch:e,...t})).sort((e,t)=>e.minuteEpoch-t.minuteEpoch);return n.NextResponse.json({data:A,debug:{stackId:m,stackName:l,itemKey:r,groups:a}})}return n.NextResponse.json({data:A})}let m=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/stacks/summary/route",pathname:"/api/stacks/summary",filename:"route",bundlePath:"app/api/stacks/summary/route"},resolvedPagePath:"C:\\Users\\User\\boaz\\frontend\\src\\app\\api\\stacks\\summary\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:l,staticGenerationAsyncStorage:c,serverHooks:p}=m,g="/api/stacks/summary/route";function v(){return(0,u.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:c})}},20728:(e,t,a)=>{a.d(t,{_:()=>s});let r=require("@prisma/client"),s=global.prisma||new r.PrismaClient({log:["warn","error"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972],()=>a(9848));module.exports=r})();
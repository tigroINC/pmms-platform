"use strict";(()=>{var e={};e.id=7331,e.ids=[7331],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},29088:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>h,requestAsyncStorage:()=>g,routeModule:()=>y,serverHooks:()=>R,staticGenerationAsyncStorage:()=>x});var s={};r.r(s),r.d(s,{DELETE:()=>w,GET:()=>p,PUT:()=>l});var i=r(49303),a=r(88716),o=r(60670),n=r(87070),u=r(75571),d=r(95456),m=r(20728),c=r(47374);async function p(e,{params:t}){try{let e=await (0,u.getServerSession)(d.L);if(!e)return n.NextResponse.json({error:"인증이 필요합니다."},{status:401});let r=t.id,s=await m._.stack.findUnique({where:{id:r},include:{customer:!0}});if(!s)return n.NextResponse.json({error:"굴뚝을 찾을 수 없습니다."},{status:404});let i=e.user.role,a=e.user.customerId;if(e.user.organizationId,("CUSTOMER_ADMIN"===i||"CUSTOMER_USER"===i)&&s.customerId!==a)return n.NextResponse.json({error:"권한이 없습니다."},{status:403});let o=await m._.measurement.findMany({where:{stackId:r},select:{itemKey:!0,weather:!0,temperatureC:!0,humidityPct:!0,pressureMmHg:!0,windDirection:!0,windSpeedMs:!0,gasVelocityMs:!0,gasTempC:!0,moisturePct:!0,oxygenMeasuredPct:!0,oxygenStdPct:!0,flowSm3Min:!0}}),p=[...new Set(o.map(e=>e.itemKey))],l=new Set;o.forEach(e=>{Object.entries(c.X5).forEach(([t,r])=>{null!==e[t]&&void 0!==e[t]&&l.add(r)})});let w=[...new Set([...p,...Array.from(l)])],y=await m._.stackMeasurementItem.findMany({where:{stackId:r},include:{item:!0}}),g=y.map(e=>e.itemKey),x=[...new Set([...w,...g])],R=await m._.item.findMany({where:{key:{in:x}}}),f=await m._.measurement.groupBy({by:["itemKey"],where:{stackId:r,itemKey:{in:R.map(e=>e.key)}},_count:{id:!0}}),h=new Map(f.map(e=>[e.itemKey,e._count.id])),_=new Map(y.map(e=>[e.itemKey,{isActive:e.isActive,order:e.order}])),M=R.map(e=>{let t=_.get(e.key),r=t?.order,s=e.order??0;return{key:e.key,name:e.name,unit:e.unit,category:e.category,limit:e.limit,measurementCount:h.get(e.key)||0,isActive:t?.isActive??!0,order:r&&0!==r?r:s,inputType:e.inputType,options:e.options}}),I=(e,t)=>0===e.order&&0!==t.order?1:0!==e.order&&0===t.order?-1:e.order===t.order?e.name.localeCompare(t.name):e.order-t.order,S=M.filter(e=>"오염물질"===e.category),N=M.filter(e=>"채취환경"===e.category||"보조항목"===e.category);S.sort(I),N.sort(I);let A=[...S,...N];return n.NextResponse.json({items:A})}catch(e){return n.NextResponse.json({error:"측정항목 조회 중 오류가 발생했습니다.",details:e.message},{status:500})}}async function l(e,{params:t}){try{let r=await (0,u.getServerSession)(d.L);if(!r)return n.NextResponse.json({error:"인증이 필요합니다."},{status:401});let s=t.id,{items:i}=await e.json();if(!Array.isArray(i))return n.NextResponse.json({error:"items 배열이 필요합니다."},{status:400});let a=await m._.stack.findUnique({where:{id:s}});if(!a)return n.NextResponse.json({error:"굴뚝을 찾을 수 없습니다."},{status:404});let o=r.user.role,c=r.user.customerId,p="CUSTOMER_ADMIN"===o||"CUSTOMER_USER"===o;if(p&&a.customerId!==c||"SUPER_ADMIN"!==o&&!("ORG_ADMIN"===o||"OPERATOR"===o)&&!p)return n.NextResponse.json({error:"권한이 없습니다."},{status:403});return await m._.$transaction(i.map(e=>m._.stackMeasurementItem.upsert({where:{stackId_itemKey:{stackId:s,itemKey:e.itemKey}},create:{stackId:s,itemKey:e.itemKey,isActive:e.isActive??!0,order:e.order??0},update:{isActive:e.isActive??!0,order:e.order??0}}))),n.NextResponse.json({ok:!0,message:"설정이 저장되었습니다."})}catch(e){return n.NextResponse.json({error:"설정 저장 중 오류가 발생했습니다."},{status:500})}}async function w(e,{params:t}){try{let e=await (0,u.getServerSession)(d.L);if(!e)return n.NextResponse.json({error:"인증이 필요합니다."},{status:401});let r=t.id,s=await m._.stack.findUnique({where:{id:r}});if(!s)return n.NextResponse.json({error:"굴뚝을 찾을 수 없습니다."},{status:404});let i=e.user.role,a=e.user.customerId,o="CUSTOMER_ADMIN"===i||"CUSTOMER_USER"===i;if(o&&s.customerId!==a||"SUPER_ADMIN"!==i&&!("ORG_ADMIN"===i||"OPERATOR"===i)&&!o)return n.NextResponse.json({error:"권한이 없습니다."},{status:403});return await m._.stackMeasurementItem.deleteMany({where:{stackId:r}}),n.NextResponse.json({ok:!0,message:"전체 기준으로 초기화되었습니다."})}catch(e){return n.NextResponse.json({error:"초기화 중 오류가 발생했습니다."},{status:500})}}let y=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/stacks/[id]/measurement-items/route",pathname:"/api/stacks/[id]/measurement-items",filename:"route",bundlePath:"app/api/stacks/[id]/measurement-items/route"},resolvedPagePath:"C:\\Users\\User\\boaz\\frontend\\src\\app\\api\\stacks\\[id]\\measurement-items\\route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:x,serverHooks:R}=y,f="/api/stacks/[id]/measurement-items/route";function h(){return(0,o.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:x})}},95456:(e,t,r)=>{r.d(t,{L:()=>n});var s=r(53797),i=r(13539),a=r(20728),o=r(98691);let n={adapter:(0,i.N)(a._),providers:[(0,s.Z)({name:"credentials",credentials:{email:{label:"이메일",type:"email"},password:{label:"비밀번호",type:"password"}},async authorize(e){if(!e?.email||!e?.password)throw Error("이메일과 비밀번호를 입력해주세요.");let t=await a._.user.findUnique({where:{email:e.email},include:{organization:!0,customer:!0}});if(!t)throw Error("등록되지 않은 이메일입니다.");if("APPROVED"!==t.status)throw Error("승인 대기 중이거나 거부된 계정입니다.");if(!t.isActive)throw Error("비활성화된 계정입니다.");if(!await o.ZP.compare(e.password,t.password))throw Error("비밀번호가 일치하지 않습니다.");return await a._.user.update({where:{id:t.id},data:{lastLoginAt:new Date,loginCount:{increment:1}}}),await a._.activityLog.create({data:{userId:t.id,action:"LOGIN",ipAddress:null,userAgent:null}}),{id:t.id,email:t.email,name:t.name,role:t.role,organizationId:t.organizationId,customerId:t.customerId,customerName:t.customer?.name||null,status:t.status,passwordResetRequired:t.passwordResetRequired}}})],callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.role=t.role,e.organizationId=t.organizationId,e.customerId=t.customerId,e.customerName=t.customerName,e.status=t.status,e.passwordResetRequired=t.passwordResetRequired),e),session:async({session:e,token:t})=>(e.user&&(e.user.id=t.id,e.user.role=t.role,e.user.organizationId=t.organizationId,e.user.customerId=t.customerId,e.user.customerName=t.customerName,e.user.status=t.status,e.user.passwordResetRequired=t.passwordResetRequired),e)},pages:{signIn:"/login",error:"/login"},session:{strategy:"jwt",maxAge:86400},secret:process.env.NEXTAUTH_SECRET}},47374:(e,t,r)=>{r.d(t,{UN:()=>s,X5:()=>i,tM:()=>a});let s={weather:"weather",temperature:"temperatureC",humidity:"humidityPct",pressure:"pressureMmHg",wind_direction:"windDirection",wind_speed:"windSpeedMs",gas_velocity:"gasVelocityMs",gas_temp:"gasTempC",moisture:"moisturePct",oxygen_measured:"oxygenMeasuredPct",oxygen_std:"oxygenStdPct",flow:"flowSm3Min"},i={weather:"weather",temperatureC:"temperature",humidityPct:"humidity",pressureMmHg:"pressure",windDirection:"wind_direction",windSpeedMs:"wind_speed",gasVelocityMs:"gas_velocity",gasTempC:"gas_temp",moisturePct:"moisture",oxygenMeasuredPct:"oxygen_measured",oxygenStdPct:"oxygen_std",flowSm3Min:"flow"};function a(e){return e in s}},20728:(e,t,r)=>{r.d(t,{_:()=>i});let s=require("@prisma/client"),i=global.prisma||new s.PrismaClient({log:["warn","error"]})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,5972,8691,9637],()=>r(29088));module.exports=s})();
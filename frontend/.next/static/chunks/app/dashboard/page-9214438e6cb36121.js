(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7702],{2861:function(e,t,a){Promise.resolve().then(a.bind(a,1645))},1645:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return v}});var r=a(7437);function n(e){let{title:t,value:a,sub:n}=e;return(0,r.jsxs)("div",{className:"rounded-lg border p-3 bg-white/50 dark:bg-white/5",children:[(0,r.jsx)("div",{className:"text-xs text-gray-500 mb-1",children:t}),(0,r.jsxs)("div",{className:"flex items-baseline gap-2",children:[(0,r.jsx)("div",{className:"text-2xl font-semibold",children:a}),n&&(0,r.jsx)("div",{className:"text-xs text-gray-400",children:n})]})]})}var l=a(2265);function s(e){let{labels:t,data:n,limit:s,title:i="농도 추이",chartType:o="line",showLimit30:d=!1,showPrediction:c=!1,showAverage:u=!1,xTimes:m,height:g,monthTicks:h,monthTickLabels:x,pointStacks:p,pointPayloads:f,exportRef:v,aiPredictions:y}=e,b=(0,l.useRef)(null),k=(0,l.useRef)(null),[w,j]=(0,l.useState)(!1);return(0,l.useEffect)(()=>{v&&(v.current=b.current)},[v,t,n,o]),(0,l.useEffect)(()=>{let e=!0;return(async()=>{try{var r;let l=await Promise.all([a.e(7674),a.e(1276)]).then(a.bind(a,5678));if(!e)return;j(!0);let g=null===(r=b.current)||void 0===r?void 0:r.getContext("2d");if(!g)return;k.current&&k.current.destroy();let v=l.default||l.Chart,w=[],N=[];if("scatter"===o){let e=(e,t)=>e instanceof Date?e.getTime():"number"==typeof e?e:e?new Date(e).getTime():t+1,t=n.map((t,a)=>({x:e(m&&m[a],a),y:t,stack:null==p?void 0:p[a],payload:null==f?void 0:f[a]})),a=new Set,r=t.filter(e=>{let t="number"==typeof e.x?Math.floor(e.x/6e4):Math.floor(new Date(e.x).getTime()/6e4),r=Number(e.y).toFixed(3),n="".concat(t,"|").concat(r,"|").concat(e.stack||"");return!a.has(n)&&(a.add(n),!0)});r.forEach(e=>{isFinite(e.y)&&N.push(e.y)}),w.push({label:"실측값",data:r,showLine:!1,borderColor:"#3B82F6",backgroundColor:"#3B82F6",pointRadius:4})}else n.forEach(e=>{isFinite(e)&&N.push(e)}),w.push({label:"실측값",data:n,borderColor:"#3B82F6",backgroundColor:"bar"===o?"rgba(59,130,246,0.6)":"rgba(59,130,246,0.2)",fill:"line"===o,tension:"line"===o?.25:0,pointRadius:"line"===o?3:0});if(y&&y.length>0){let e=y.map(e=>e.date),t=y.map(e=>e.predicted_value),a=y.map(e=>e.lower_bound),r=y.map(e=>e.upper_bound);"scatter"===o?(w.push({label:"AI 예측 (AutoML)",data:t.map((t,a)=>({x:new Date(e[a]).getTime(),y:t})),showLine:!0,borderColor:"#10B981",backgroundColor:"#10B981",pointRadius:5,pointHoverRadius:8,borderDash:[8,4],borderWidth:3}),w.push({label:"예측 상한",data:r.map((t,a)=>({x:new Date(e[a]).getTime(),y:t})),showLine:!0,borderColor:"rgba(16,185,129,0.3)",backgroundColor:"rgba(16,185,129,0.1)",pointRadius:0,borderDash:[2,2],fill:!1}),w.push({label:"예측 하한",data:a.map((t,a)=>({x:new Date(e[a]).getTime(),y:t})),showLine:!0,borderColor:"rgba(16,185,129,0.3)",backgroundColor:"rgba(16,185,129,0.1)",pointRadius:0,borderDash:[2,2],fill:"-1"})):w.push({label:"AI 예캁 (AutoML)",data:[...Array(n.length).fill(null),...t],borderColor:"#10B981",backgroundColor:"rgba(16,185,129,0.2)",fill:!1,borderDash:[8,4],borderWidth:3,tension:.3,pointRadius:3})}if(c){let e=Math.min(7,Math.max(3,Math.floor(n.length/10))),t=[];for(let a=0;a<n.length;a++){let r=Math.max(0,a-e+1),l=n.slice(r,a+1),s=l.length?l.reduce((e,t)=>e+t,0)/l.length:0;t.push(Number(s.toFixed(2)))}"scatter"===o?w.push({label:"이동평균선",data:t.map((e,t)=>({x:m&&m[t]?m[t]instanceof Date?m[t].getTime():"number"==typeof m[t]?m[t]:new Date(m[t]).getTime():t+1,y:e})),showLine:!0,borderColor:"#F59E0B",backgroundColor:"#F59E0B",pointRadius:0,pointHitRadius:0,hoverRadius:0,borderDash:[5,5],borderWidth:2}):w.push({label:"이동평균선",data:t,borderColor:"#F59E0B",backgroundColor:"rgba(245,158,11,0.2)",fill:!1,borderDash:[5,5],tension:.3,pointRadius:0,borderWidth:2})}if(void 0!==s&&("scatter"===o?w.push({label:"배출허용기준",data:[{x:m&&m.length?m[0]instanceof Date?m[0].getTime():"number"==typeof m[0]?m[0]:new Date(m[0]).getTime():1,y:s},{x:m&&m.length?m[m.length-1]instanceof Date?m[m.length-1].getTime():"number"==typeof m[m.length-1]?m[m.length-1]:new Date(m[m.length-1]).getTime():n.length,y:s}],borderColor:"#EF4444",borderDash:[6,6],pointRadius:0,pointHitRadius:0,hoverRadius:0,fill:!1,showLine:!0}):w.push({label:"배출허용기준",data:Array(t.length).fill(s),borderColor:"#EF4444",borderDash:[6,6],pointRadius:0,fill:!1}),d)){let e=Number((.3*s).toFixed(1));"scatter"===o?w.push({label:"30% 기준",data:[{x:m&&m.length?m[0]instanceof Date?m[0].getTime():"number"==typeof m[0]?m[0]:new Date(m[0]).getTime():1,y:e},{x:m&&m.length?m[m.length-1]instanceof Date?m[m.length-1].getTime():"number"==typeof m[m.length-1]?m[m.length-1]:new Date(m[m.length-1]).getTime():n.length,y:e}],borderColor:"#60A5FA",pointRadius:0,pointHitRadius:0,hoverRadius:0,fill:!1,showLine:!0}):w.push({label:"30% 기준",data:Array(t.length).fill(e),borderColor:"#60A5FA",pointRadius:0,fill:!1})}if("scatter"===o&&u&&n.length){let e=n.filter(e=>Number.isFinite(e)),t=e.length?e.reduce((e,t)=>e+t,0)/e.length:0;w.push({label:"평균",data:[{x:m&&m.length?m[0]instanceof Date?m[0].getTime():"number"==typeof m[0]?m[0]:new Date(m[0]).getTime():1,y:t},{x:m&&m.length?m[m.length-1]instanceof Date?m[m.length-1].getTime():"number"==typeof m[m.length-1]?m[m.length-1]:new Date(m[m.length-1]).getTime():n.length,y:t}],borderColor:"#10B981",pointRadius:0,pointHitRadius:0,hoverRadius:0,fill:!1,showLine:!0,borderDash:[4,4]})}let S=N.length?Math.min(...N):0,C=N.length?Math.max(...N):1,D=isFinite(S)&&isFinite(C)&&S===C?0===C?1:.2*Math.abs(C):Math.max(.1*Math.abs(C-S),.01);k.current=new v(g,{type:"scatter"===o?"scatter":o,data:{labels:t,datasets:w},options:{responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:0,bottom:10,left:10,right:10}},plugins:{legend:{display:!0,position:"top",align:"end",labels:{boxWidth:12,boxHeight:12,padding:8,font:{size:11}}},title:{display:!0,text:i,position:"top",align:"start",padding:{top:5,bottom:5},font:{size:16,weight:"600"}},tooltip:{intersect:"scatter"===o,mode:"scatter"===o?"point":"index",filter:"scatter"===o?e=>{var t;let a=null==e?void 0:null===(t=e.dataset)||void 0===t?void 0:t.label;return"실측값"===a||"AI 예측 (AutoML)"===a}:void 0,callbacks:"scatter"===o?{title:e=>{try{var t,a;let r=(e||[]).find(e=>{var t,a;return e&&((null===(t=e.raw)||void 0===t?void 0:t.payload)||(null===(a=e.raw)||void 0===a?void 0:a.stack))})||(null==e?void 0:e[0]);if(!r)return"";let n=(r.raw||{}).payload||{},l=null!==(a=n.measuredAt)&&void 0!==a?a:null===(t=r.parsed)||void 0===t?void 0:t.x;if(!l)return"";let s=new Date(l);if(isNaN(s.getTime()))return"";return"".concat(s.getFullYear(),"-").concat(String(s.getMonth()+1).padStart(2,"0"),"-").concat(String(s.getDate()).padStart(2,"0")," ").concat(String(s.getHours()).padStart(2,"0"),":").concat(String(s.getMinutes()).padStart(2,"0"))}catch(e){return""}},label:e=>{try{var t,a,r,n,l,s,i;let o=e.raw||{},d=o.payload||{},c=[];if((null===(t=e.dataset)||void 0===t?void 0:t.label)==="AI 예측 (AutoML)"){let t="number"==typeof o.y?o.y:null===(i=e.parsed)||void 0===i?void 0:i.y;return c.push("\uD83E\uDD16 AI 예측값: ".concat((null==t?void 0:t.toFixed(2))||"N/A"," mg/S㎥")),c.push(""),c.push("\uD83D\uDCCA 예측 정보:"),c.push("• Prophet AutoML 모델 기반"),c.push("• 고객사 전체 굴뚝 데이터 학습"),c.push("• 과거 패턴 및 계절성 반영"),c.push("• 30일 미래 예측"),c}let u=o.stack||(null===(a=d.stack)||void 0===a?void 0:a.name)||"";u&&c.push("굴뚝: ".concat(u));let m="number"==typeof o.y?o.y:null===(r=e.parsed)||void 0===r?void 0:r.y,g=(null===(n=d.item)||void 0===n?void 0:n.unit)||"";return null!=m&&c.push("농도: ".concat(m).concat(g?" "+g:"")),(null===(l=d.item)||void 0===l?void 0:l.limit)!==void 0&&(null===(s=d.item)||void 0===s?void 0:s.limit)!==null&&c.push("허용기준: ".concat(d.item.limit)),void 0!==d.flowSm3Min&&null!==d.flowSm3Min&&c.push("유량: ".concat(d.flowSm3Min," Sm3/m")),void 0!==d.gasVelocityMs&&null!==d.gasVelocityMs&&c.push("가스속도: ".concat(d.gasVelocityMs," m/s")),void 0!==d.gasTempC&&null!==d.gasTempC&&c.push("가스온도: ".concat(d.gasTempC," ℃")),void 0!==d.moisturePct&&null!==d.moisturePct&&c.push("수분함량: ".concat(d.moisturePct,"%")),void 0!==d.oxygenStdPct&&null!==d.oxygenStdPct&&c.push("표준산소: ".concat(d.oxygenStdPct,"%")),void 0!==d.oxygenMeasuredPct&&null!==d.oxygenMeasuredPct&&c.push("실측산소: ".concat(d.oxygenMeasuredPct,"%")),void 0!==d.windSpeedMs&&null!==d.windSpeedMs&&c.push("풍속: ".concat(d.windSpeedMs," m/s")),d.weather&&c.push("기상: ".concat(d.weather)),d.measuringCompany&&c.push("측정업체: ".concat(d.measuringCompany)),c.length?c:""}catch(e){return""}}}:void 0}},interaction:"scatter"===o?{mode:"point",intersect:!0}:void 0,scales:{x:"scatter"===o?{type:"linear",beginAtZero:!1,min:h&&h.length?h[0]:void 0,max:h&&h.length?h[h.length-1]:void 0,afterBuildTicks:e=>{h&&h.length&&(e.ticks=h.map((e,t)=>{var a;return{value:e,label:null!==(a=null==x?void 0:x[t])&&void 0!==a?a:""}}))},ticks:{autoSkip:!1,maxRotation:0,padding:2,callback:(e,t,a)=>{let r=a&&a[t];if(r&&"string"==typeof r.label)return r.label;let n=Number(e);if(!isFinite(n))return"";let l=(new Date(n).getMonth()+1).toString().padStart(2,"0");return"".concat(l,"월")}}}:{beginAtZero:!0},y:{beginAtZero:!1,suggestedMin:Math.max(0,S-D),suggestedMax:C+D}}},plugins:[{id:"lineValueLabels",afterDatasetsDraw:e=>{let t=e.ctx,a=e.chartArea;e.data.datasets.forEach((r,n)=>{if(e.getDatasetMeta(n).visible&&("배출허용기준"===r.label||"30% 기준"===r.label||"평균"===r.label)&&r.data&&r.data.length>0){let n="scatter"===o?r.data[0].y:r.data[0],l=e.scales.y.getPixelForValue(n);t.save(),t.fillStyle=r.borderColor||"#666",t.font="bold 11px sans-serif",t.textAlign="left",t.textBaseline="bottom";let s="".concat(n.toFixed(1)),i=a.left+5,d=l-3,c=t.measureText(s).width;t.fillStyle="rgba(255, 255, 255, 0.9)",t.fillRect(i-2,d-12,c+4,14),t.fillStyle=r.borderColor||"#666",t.fillText(s,i,d),t.restore()}})}}]})}catch(e){j(!1)}})(),()=>{e=!1,k.current&&k.current.destroy()}},[t,n,s,i,o,d,c,u,m,y]),(0,r.jsxs)("div",{className:"w-full rounded-lg border bg-white/50 dark:bg-white/5 p-3",style:{height:(null!=g?g:256)+"px"},children:[(0,r.jsx)("canvas",{ref:b,className:"h-full w-full"}),!w&&(0,r.jsx)("div",{className:"h-full w-full -mt-64 flex items-center justify-center text-xs text-gray-500",children:"차트 라이브러리 미설치 상태입니다. chart.js 설치 후 자동 렌더링됩니다."})]})}var i=a(2827),o=a(6819);function d(e){let{open:t,onClose:a,summaries:n,loading:s,initialSelectedNames:i=[],onApply:o}=e,[d,c]=(0,l.useState)(""),[u,m]=(0,l.useState)(i);(0,l.useEffect)(()=>{t&&m(i)},[t,i]);let g=(0,l.useMemo)(()=>{let e=d.trim(),t=[...n];return e&&(t=t.filter(t=>t.stackName.toLowerCase().includes(e.toLowerCase()))),t.sort((e,t)=>t.avg-e.avg||e.stackName.localeCompare(t.stackName)),t},[n,d]);return t?(0,r.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[(0,r.jsx)("div",{className:"absolute inset-0 bg-black/40",onClick:a}),(0,r.jsxs)("div",{className:"relative bg-white dark:bg-neutral-900 rounded shadow-xl w-[880px] max-h-[80vh] flex flex-col",children:[(0,r.jsxs)("div",{className:"px-4 py-3 border-b flex items-center gap-3",children:[(0,r.jsx)("h2",{className:"text-lg font-semibold",children:"굴뚝 선택"}),(0,r.jsx)("div",{className:"ml-auto flex items-center gap-2",children:(0,r.jsx)("input",{value:d,onChange:e=>c(e.target.value),placeholder:"굴뚝 검색",className:"border rounded px-3 py-1 bg-transparent"})})]}),(0,r.jsx)("div",{className:"p-4 flex-1 overflow-auto",children:s?(0,r.jsx)("div",{className:"py-12 text-center text-sm text-neutral-500",children:"불러오는 중…"}):(0,r.jsxs)("table",{className:"w-full text-sm",children:[(0,r.jsx)("thead",{children:(0,r.jsxs)("tr",{className:"text-left border-b",children:[(0,r.jsx)("th",{className:"py-2 px-2 w-10",children:"선택"}),(0,r.jsx)("th",{className:"py-2 px-2",children:"굴뚝"}),(0,r.jsx)("th",{className:"py-2 px-2",children:"평균농도"}),(0,r.jsx)("th",{className:"py-2 px-2",children:"측정건수"}),(0,r.jsx)("th",{className:"py-2 px-2",children:"기준초과"}),(0,r.jsx)("th",{className:"py-2 px-2",children:"최근측정"})]})}),(0,r.jsx)("tbody",{children:g.map(e=>{let t=u.includes(e.stackName);return(0,r.jsxs)("tr",{className:"border-b hover:bg-neutral-50 dark:hover:bg-neutral-800",children:[(0,r.jsx)("td",{className:"py-2 px-2",children:(0,r.jsx)("input",{type:"checkbox",checked:t,onChange:t=>{let a=t.currentTarget.checked;m(t=>a?Array.from(new Set([...t,e.stackName])):t.filter(t=>t!==e.stackName))}})}),(0,r.jsx)("td",{className:"py-2 px-2",children:e.stackName}),(0,r.jsx)("td",{className:"py-2 px-2",children:e.avg}),(0,r.jsx)("td",{className:"py-2 px-2",children:e.count}),(0,r.jsx)("td",{className:"py-2 px-2",children:e.exceedCount}),(0,r.jsx)("td",{className:"py-2 px-2",children:e.lastMeasuredAt?new Date(e.lastMeasuredAt).toLocaleDateString():"-"})]},e.stackId)})})]})}),(0,r.jsxs)("div",{className:"px-4 py-3 border-t flex items-center gap-2",children:[(0,r.jsx)("button",{className:"px-3 py-1 border rounded",onClick:()=>{m(g.map(e=>e.stackName))},children:"모두 선택"}),(0,r.jsx)("button",{className:"px-3 py-1 border rounded",onClick:()=>m([]),children:"모두 해제"}),(0,r.jsx)("button",{className:"px-3 py-1 border rounded",onClick:()=>{m(g.slice(0,5).map(e=>e.stackName))},children:"Top 5 선택"}),(0,r.jsx)("button",{className:"px-3 py-1 border rounded",onClick:()=>{m(g.filter(e=>{var t;return(null!==(t=e.exceedCount)&&void 0!==t?t:0)>0}).map(e=>e.stackName))},children:"기준초과만"}),(0,r.jsx)("div",{className:"ml-auto"}),(0,r.jsx)("button",{className:"px-3 py-1 border rounded",onClick:a,children:"취소"}),(0,r.jsx)("button",{className:"px-3 py-1 bg-blue-600 text-white rounded",onClick:()=>o(u),children:"적용"})]})]})]}):null}var c=a(4755),u=a(8776),m=a(9548),g=a(2891);let h="http://localhost:8000";var x=a(6334),p=a(605);function f(e){let{itemKey:t,selected:a,onChange:n}=e,l=e=>{a.includes(e)?n(a.filter(t=>t!==e)):n([...a,e])};return(0,r.jsx)("div",{className:"flex flex-wrap gap-2",children:("weather"===t?["맑음","흐림","비","눈","구름","안개"]:"wind_dir"===t||"wind_direction"===t?["북","북동","동","남동","남","남서","서","북서"]:[]).map(e=>(0,r.jsxs)("label",{className:"inline-flex items-center gap-1 text-xs cursor-pointer",children:[(0,r.jsx)("input",{type:"checkbox",className:"accent-blue-500",checked:a.includes(e),onChange:()=>l(e)}),(0,r.jsx)("span",{className:"text-gray-700 dark:text-gray-300",children:e})]},e))})}function v(){var e,t;let{selectedOrg:a,loading:v}=(0,g.o)(),{list:y}=(0,c.n)(),{items:b}=(0,u.F)(),{data:k}=(0,p.useSession)(),w=null==k?void 0:null===(e=k.user)||void 0===e?void 0:e.role,j=null==k?void 0:null===(t=k.user)||void 0===t?void 0:t.customerId,[N,S]=(0,l.useState)([]),[C,D]=(0,l.useState)("전체"),A=sessionStorage.getItem("viewAsCustomer"),M="SUPER_ADMIN"===w&&!!A,R="CUSTOMER_ADMIN"===w||"CUSTOMER_USER"===w||M,E=(()=>{let e=new Date,t=new Date(e);t.setMonth(e.getMonth()-6);let a=e=>{let t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return"".concat(t,"-").concat(a,"-").concat(r)};return{start:a(t),end:a(e)}})(),[F,_]=(0,l.useState)("전체"),[I,T]=(0,l.useState)([]),[P,L]=(0,l.useState)("먼지"),[O,U]=(0,l.useState)(E.start),[z,Z]=(0,l.useState)(E.end),[K,B]=(0,l.useState)({customer:"전체",stack:"전체",item:"먼지",start:E.start,end:E.end}),[H,Y]=(0,l.useState)("scatter"),[V,W]=(0,l.useState)(!1),[J,$]=(0,l.useState)(!1),[q,G]=(0,l.useState)(!1),{predict:Q,loading:X,error:ee,result:et}=function(){let[e,t]=(0,l.useState)(!1),[a,r]=(0,l.useState)(null),[n,s]=(0,l.useState)(null);return{predict:async e=>{t(!0),r(null);try{let t=await fetch("".concat(h,"/api/predict"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({customer_id:e.customer_id,stack:e.stack,item_key:e.item_key,periods:e.periods||30,include_history:!0})});if(!t.ok){let e=await t.json();throw Error(e.detail||"예측 실패")}let a=await t.json();return s(a),a}catch(e){return r(e.message||"AutoML 예측 중 오류가 발생했습니다."),null}finally{t(!1)}},checkHealth:async()=>{try{return(await fetch("".concat(h,"/health"))).ok}catch(e){return!1}},reset:()=>{s(null),r(null)},loading:e,error:a,result:n}}(),[ea,er]=(0,l.useState)([]),[en,el]=(0,l.useState)(""),[es,ei]=(0,l.useState)(!1),[eo,ed]=(0,l.useState)(!1),[ec,eu]=(0,l.useState)(!1),[em,eg]=(0,l.useState)(""),[eh,ex]=(0,l.useState)(!1),[ep,ef]=(0,l.useState)(!1),[ev,ey]=(0,l.useState)(""),[eb,ek]=(0,l.useState)(""),ew=(0,l.useMemo)(()=>b.filter(e=>"보조항목"===e.category).filter(e=>"wind_direction"!==e.key).map(e=>{let t="weather"===e.key||"wind_dir"===e.key||"wind_direction"===e.key;return{name:e.name,itemKey:e.key,mode:t?"category":"numeric"}}),[b]),[ej,eN]=(0,l.useState)([]),eS=e=>eN(t=>t.filter(t=>t.id!==e)),eC=(e,t)=>eN(a=>a.map(a=>a.id===e?{...a,...t}:a)),eD=(0,l.useMemo)(()=>{var e;if("전체"!==F)return null===(e=y.find(e=>e.name===F))||void 0===e?void 0:e.id},[y,F]),eA=(0,l.useMemo)(()=>{var e;return R?A||j:"전체"!==K.customer?null===(e=y.find(e=>e.name===K.customer))||void 0===e?void 0:e.id:void 0},[y,K.customer,R,A,j]),eM=(0,l.useMemo)(()=>b.find(e=>e.name===K.item),[b,K.item]),{list:eR}=(0,m.D)(eD),eE=["weather","temp","humidity","pressure","wind_dir","wind_speed","gas_velocity","gas_temp","moisture","o2_measured","o2_standard","flow_rate"],[eF,e_]=(0,l.useState)(b);(0,l.useEffect)(()=>{let e=new URLSearchParams;eD&&e.set("customerId",eD),I.length&&I.forEach(t=>e.append("stack",t)),fetch("/api/items?".concat(e.toString())).then(e=>e.json()).then(e=>{e_((Array.isArray(e.data)?e.data:[]).filter(e=>!eE.includes(e.key)))}).catch(()=>{e_(b.filter(e=>!eE.includes(e.key)))})},[eD,I,b]),(0,l.useEffect)(()=>{R&&fetch(A?"/api/customer-organizations?viewAsCustomer=".concat(A):"/api/customer-organizations").then(e=>e.json()).then(e=>{S(e.organizations||[])}).catch(e=>console.error("Failed to fetch customer organizations:",e))},[R,A]),(0,l.useEffect)(()=>{if(y.length&&"전체"===F){if(R&&j){let e=y.find(e=>e.id===j);e&&_(e.name)}else{let e=y.find(e=>e.name.includes("고려아연"))||y[0];e&&_(e.name)}}if(b.length&&(!P||""===P)){let e=b.find(e=>"먼지"===e.name)||b[0];e&&L(e.name)}},[y,b,R,j]),(0,l.useEffect)(()=>{if("전체"!==F&&P){let e={customer:F,stack:I.join(","),item:P,start:O,end:z};K.customer===e.customer&&K.stack===e.stack&&K.item===e.item&&K.start===e.start&&K.end===e.end||B(e)}},[F,I,P,O,z]);let{data:eI}=(0,u.r)({customerId:eA,stacks:"전체"===K.stack||""===K.stack?void 0:K.stack.split(",").filter(Boolean),itemKey:null==eM?void 0:eM.key,page:1,pageSize:999999,start:K.start,end:K.end,sort:{key:"measuredAt",dir:"asc"}}),[eT,eP]=(0,l.useState)({}),[eL,eO]=(0,l.useState)(!1);(0,l.useEffect)(()=>{(async()=>{if(!ej.length){eP({}),eO(!1);return}eO(!0);let e=new URLSearchParams;eA&&e.set("customerId",eA),K.stack&&""!==K.stack&&"전체"!==K.stack&&K.stack.split(",").filter(Boolean).forEach(t=>e.append("stack",t)),K.start&&e.set("start",K.start),K.end&&e.set("end",K.end);try{let t=await Promise.all(ej.map(async t=>{let a=new URLSearchParams(e);a.set("itemKey",t.itemKey);let r="/api/measurements?".concat(a.toString()),n=await fetch(r),l=await n.json(),s=Array.isArray(null==l?void 0:l.data)?l.data:[],i=new Map;for(let e of s){var o,d;let t=e.measuredAt?new Date(e.measuredAt):null,a=t?Math.floor(t.getTime()/6e4):e.measuredAt,r=(null===(o=e.stack)||void 0===o?void 0:o.id)||e.stackId||(null===(d=e.stack)||void 0===d?void 0:d.name)||"",n="".concat(r,"|").concat(a),l=e.value;i.set(n,l)}return[t.itemKey,i]})),a={};for(let[e,r]of t)a[e]=r;eP(a),eO(!1)}catch(e){eP({}),eO(!1)}})()},[JSON.stringify(ej),eA,K.stack,K.start,K.end]);let eU=(0,l.useMemo)(()=>{let e=""!==ev?Number(ev):void 0,t=""!==eb?Number(eb):void 0,a=eI.filter(a=>{let r=Number(a.value);return!!Number.isFinite(r)&&(void 0===e||!(r<e))&&(void 0===t||!(r>t))}),r=ej.filter(e=>"numeric"===e.mode?void 0!==e.min&&""!==e.min&&void 0!==e.max&&""!==e.max:e.categories&&e.categories.length>0);return r.length&&!eL&&r.every(e=>eT[e.itemKey])?a.filter(e=>{var t,a;let n=e.measuredAt?new Date(e.measuredAt):null,l=n?Math.floor(n.getTime()/6e4):e.measuredAt,s=(null===(t=e.stack)||void 0===t?void 0:t.id)||e.stackId||(null===(a=e.stack)||void 0===a?void 0:a.name)||"",i="".concat(s,"|").concat(l);for(let e of r){let t=eT[e.itemKey].get(i);if(null==t)return!1;if("numeric"===e.mode){let a=Number(t);if(!Number.isFinite(a))return!1;let r=Number(e.min),n=Number(e.max);if(a<r||a>n)return!1}else{let a=e.categories||[],r=String(t).trim();if(!a.includes(r))return!1}}return!0}):a},[eI,ev,eb,JSON.stringify(ej),eT]),{data:ez,loading:eZ}=function(e){let{customerId:t,itemKey:a,start:r,end:n,open:s}=e||{},[i,o]=(0,l.useState)([]),[d,c]=(0,l.useState)(!1);return(0,l.useEffect)(()=>{let e=!0;if(!s||!t||!a||!r||!n){o([]);return}c(!0);let l=new URLSearchParams;return l.set("customerId",t),l.set("itemKey",a),l.set("start",r),l.set("end",n),fetch("/api/stacks/summary?".concat(l.toString())).then(e=>e.json()).then(t=>{e&&o(Array.isArray(t.data)?t.data:[])}).catch(()=>{e&&o([])}).finally(()=>{e&&c(!1)}),()=>{e=!1}},[t,a,r,n,s]),{data:i,loading:d}}({customerId:eA,itemKey:null==eM?void 0:eM.key,start:K.start,end:K.end,open:ep}),eK=(0,l.useMemo)(()=>{if("scatter"!==H)return;let e=new Set,t=[];for(let l of eU){var a,r,n;let s=l.measuredAt?new Date(l.measuredAt):null,i=s?Math.floor(s.getTime()/6e4):l.measuredAt,o="number"==typeof l.value?l.value.toFixed(3):String(l.value),d=(null===(a=l.stack)||void 0===a?void 0:a.id)||l.stackId||(null===(r=l.stack)||void 0===r?void 0:r.name)||"",c=l.itemKey||(null===(n=l.item)||void 0===n?void 0:n.key)||"",u=l.id||"".concat(d,"|").concat(c,"|").concat(i,"|").concat(o);e.has(u)||(e.add(u),t.push(l))}let l=t.map(e=>{let t=new Date(e.measuredAt),a=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0"),n=String(t.getHours()).padStart(2,"0"),l=String(t.getMinutes()).padStart(2,"0");return"".concat(a,"/").concat(r," ").concat(n,":").concat(l)});return{labels:l,values:t.map(e=>Number(e.value)),times:t.map(e=>e.measuredAt),stacks:t.map(e=>{var t;return(null===(t=e.stack)||void 0===t?void 0:t.name)||""}),payloads:t}},[eU,H]),eB=(0,l.useMemo)(()=>{var e,t,a,r;let n=null!==(r=null!==(a=null===(t=eU[0])||void 0===t?void 0:null===(e=t.item)||void 0===e?void 0:e.limit)&&void 0!==a?a:null==eM?void 0:eM.limit)&&void 0!==r?r:0;if("scatter"===H)return{labels:(null==eK?void 0:eK.labels)||[],data:(null==eK?void 0:eK.values)||[],limit:n};let l=new Date(K.start),s=new Date(K.end),i=l.getFullYear(),{labels:o,data:d}=function(e,t){let a=[],r={},n=new Date(e.y,e.m-1,1),l=new Date(t.y,t.m-1,1);for(;n<=l;){let e="".concat(n.getFullYear(),"-").concat((n.getMonth()+1).toString().padStart(2,"0"));a.push("".concat(n.getMonth()+1,"월")),r[e]=[],n.setMonth(n.getMonth()+1)}for(let e of eU){let t=new Date(e.measuredAt),a="".concat(t.getFullYear(),"-").concat((t.getMonth()+1).toString().padStart(2,"0"));a in r&&r[a].push(Number(e.value))}return{labels:a,data:Object.keys(r).map(e=>{let t=r[e];return 0===t.length?0:t.reduce((e,t)=>e+t,0)/t.length})}}({y:i,m:l.getMonth()+1},{y:s.getFullYear(),m:s.getMonth()+1});return{labels:o,data:d,limit:n}},[eU,K.start,K.end,null==eM?void 0:eM.limit,H]),eH=(0,l.useMemo)(()=>{let e=eU.map(e=>Number(e.value)),t=e.length,a=new Date;return{totalCount:t,monthCount:eU.filter(e=>{let t=new Date(e.measuredAt);return t.getFullYear()===a.getFullYear()&&t.getMonth()===a.getMonth()}).length,exceed:eU.filter(e=>{var t;return eM&&Number(e.value)>(null!==(t=eM.limit)&&void 0!==t?t:1/0)}).length,avg:Number((e.length?e.reduce((e,t)=>e+t,0)/e.length:0).toFixed(1))}},[eU,eM]),eY=(0,l.useMemo)(()=>"scatter"===H?null==eK?void 0:eK.times:void 0,[eK,H]),eV=(0,l.useMemo)(()=>"scatter"===H?null==eK?void 0:eK.stacks:void 0,[eK,H]),eW=(0,l.useMemo)(()=>{if("scatter"!==H)return;let e=[],t=new Date(K.start),a=new Date(K.end),r=new Date(t.getFullYear(),t.getMonth(),1),n=new Date(a.getFullYear(),a.getMonth(),1);for(;r<=n;)e.push(r.getTime()),r.setMonth(r.getMonth()+1);return e},[K.start,K.end,H]),eJ=(0,l.useMemo)(()=>{if(eW)return eW.map(e=>{let t=new Date(e);return"".concat(t.getMonth()+1,"월")})},[eW]),e$=(0,l.useRef)(null);return v?(0,r.jsx)("div",{className:"flex items-center justify-center h-screen",children:(0,r.jsx)("div",{className:"text-lg",children:"로딩 중..."})}):R||a?(0,r.jsxs)("section",{className:"space-y-6",children:[(0,r.jsx)("h1",{className:"text-2xl font-semibold",children:"통계 차트 대시보드"}),(0,r.jsxs)("div",{className:"grid grid-cols-12 gap-4",children:[(0,r.jsx)("aside",{className:"col-span-12 md:col-span-2 bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 rounded-lg border border-gray-200 dark:border-gray-700",children:(0,r.jsxs)("div",{className:"sticky top-20 p-4 space-y-4",children:[(0,r.jsx)("div",{className:"space-y-1",children:R?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("label",{className:"text-sm",children:"환경측정기업"}),(0,r.jsxs)(o.Z,{className:"bg-white dark:bg-gray-700 text-gray-900 dark:text-white border-gray-300 dark:border-gray-600",value:C,onChange:e=>D(e.target.value),children:[(0,r.jsx)("option",{value:"전체",children:"통합 데이터 (전체)"}),N.map(e=>(0,r.jsx)("option",{value:e.id,children:e.nickname||e.name},e.id))]}),(0,r.jsx)("div",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:"특정 측정회사 또는 통합 데이터 선택"})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("label",{className:"text-sm",children:"고객사"}),(0,r.jsxs)(o.Z,{className:"bg-white dark:bg-gray-700 text-gray-900 dark:text-white border-gray-300 dark:border-gray-600",value:F,onChange:e=>_(e.target.value),children:[(0,r.jsx)("option",{value:"전체",children:"전체"}),y.map(e=>(0,r.jsxs)("option",{value:e.name,children:[e.name," (",e.code,")"]},e.id))]})]})}),(0,r.jsxs)("div",{className:"space-y-1",children:[(0,r.jsx)("label",{className:"text-sm",children:"굴뚝"}),(0,r.jsx)("div",{className:"flex items-center gap-2",children:(0,r.jsxs)("button",{className:"px-3 py-2 border rounded w-full border-gray-300 dark:border-gray-600 hover:bg-gray-200 dark:hover:bg-gray-700",onClick:()=>ef(!0),children:["스택 선택",I.length?" (".concat(I.length,")"):""]})}),I.length>0&&(0,r.jsx)("div",{className:"text-xs text-gray-300 truncate",children:I.join(", ")})]}),(0,r.jsxs)("div",{className:"space-y-1",children:[(0,r.jsx)("label",{className:"text-sm",children:"항목"}),(0,r.jsx)(o.Z,{className:"bg-white dark:bg-gray-700 text-gray-900 dark:text-white border-gray-300 dark:border-gray-600",value:P,onChange:e=>L(e.target.value),children:eF.map(e=>(0,r.jsx)("option",{value:e.name,children:e.name},e.key))})]}),(0,r.jsxs)("div",{className:"space-y-2 pt-2 border-t border-gray-300 dark:border-gray-700",children:[(0,r.jsx)("label",{className:"text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300",children:"\uD83D\uDCC5 기간 설정"}),(0,r.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,r.jsxs)("div",{className:"flex flex-col gap-0.5",children:[(0,r.jsx)("label",{className:"text-xs text-gray-600 dark:text-gray-400",children:"시작일"}),(0,r.jsx)(i.Z,{className:"w-full text-xs sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white border-gray-300 dark:border-gray-600",type:"date",value:O,onChange:e=>U(e.target.value)})]}),(0,r.jsxs)("div",{className:"flex flex-col gap-0.5",children:[(0,r.jsx)("label",{className:"text-xs text-gray-600 dark:text-gray-400",children:"종료일"}),(0,r.jsx)(i.Z,{className:"w-full text-xs sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white border-gray-300 dark:border-gray-600",type:"date",value:z,onChange:e=>Z(e.target.value)})]})]})]}),(0,r.jsxs)("div",{className:"space-y-2 pt-2 border-t border-gray-300 dark:border-gray-700",children:[(0,r.jsx)("label",{className:"text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300",children:"\uD83D\uDCCA 값 범위"}),(0,r.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,r.jsxs)("div",{className:"flex flex-col gap-0.5",children:[(0,r.jsx)("label",{className:"text-xs text-gray-600 dark:text-gray-400",children:"최소값"}),(0,r.jsx)(i.Z,{className:"w-full text-xs sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white border-gray-300 dark:border-gray-600",type:"number",placeholder:"0",value:ev,onChange:e=>ey(e.target.value)})]}),(0,r.jsxs)("div",{className:"flex flex-col gap-0.5",children:[(0,r.jsx)("label",{className:"text-xs text-gray-600 dark:text-gray-400",children:"최대값"}),(0,r.jsx)(i.Z,{className:"w-full text-xs sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white border-gray-300 dark:border-gray-600",type:"number",placeholder:"100",value:eb,onChange:e=>ek(e.target.value)})]})]})]}),(0,r.jsxs)("div",{className:"space-y-2 pt-2 border-t border-gray-300 dark:border-gray-700",children:[(0,r.jsx)("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"\uD83C\uDF21️ 보조항목 필터"}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("button",{className:"px-2 py-1 border border-gray-300 dark:border-gray-600 rounded text-xs hover:bg-gray-200 dark:hover:bg-gray-700",onClick:()=>{let e=ew[0];if(!e)return;let t=e.mode;eN(a=>[...a,{id:Math.random().toString(36).slice(2),itemKey:e.itemKey,itemName:e.name,mode:t}])},children:"+ 항목 추가"}),(0,r.jsx)("button",{className:"px-2 py-1 border border-gray-300 dark:border-gray-600 rounded text-xs hover:bg-gray-200 dark:hover:bg-gray-700",onClick:()=>{eN([]),ey(""),ek("")},children:"초기화"})]}),0===ej.length&&(0,r.jsx)("div",{className:"text-xs text-gray-400",children:"보조항목으로 필터링할 수 있습니다. 예) 풍속 0~5"}),(0,r.jsx)("div",{className:"space-y-2",children:ej.map(e=>{var t,a;return(0,r.jsxs)("div",{className:"space-y-1 p-2 border border-gray-300 dark:border-gray-600 rounded",children:[(0,r.jsxs)("div",{className:"space-y-1",children:[(0,r.jsx)(o.Z,{className:"w-full bg-white dark:bg-gray-700 text-gray-900 dark:text-white border-gray-300 dark:border-gray-600 text-xs",value:e.itemName,onChange:t=>{let a=t.target.value,r=ew.find(e=>e.name===a);r&&eC(e.id,{itemKey:r.itemKey,itemName:r.name,mode:r.mode})},children:ew.map(e=>(0,r.jsx)("option",{value:e.name,children:e.name},e.itemKey))}),(0,r.jsx)("button",{className:"w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded text-xs hover:bg-gray-200 dark:hover:bg-gray-700",onClick:()=>eS(e.id),children:"삭제"})]}),"numeric"===e.mode?(0,r.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,r.jsxs)("div",{className:"flex flex-col gap-0.5",children:[(0,r.jsx)("label",{className:"text-xs text-gray-600 dark:text-gray-400",children:"최소"}),(0,r.jsx)(i.Z,{className:"w-full text-xs sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white border-gray-300 dark:border-gray-600",type:"number",value:null!==(t=e.min)&&void 0!==t?t:"",onChange:t=>eC(e.id,{min:t.target.value})})]}),(0,r.jsxs)("div",{className:"flex flex-col gap-0.5",children:[(0,r.jsx)("label",{className:"text-xs text-gray-600 dark:text-gray-400",children:"최대"}),(0,r.jsx)(i.Z,{className:"w-full text-xs sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white border-gray-300 dark:border-gray-600",type:"number",value:null!==(a=e.max)&&void 0!==a?a:"",onChange:t=>eC(e.id,{max:t.target.value})})]})]}):(0,r.jsx)(f,{itemKey:e.itemKey,selected:e.categories||[],onChange:t=>eC(e.id,{categories:t})})]},e.id)})})]})]})}),(0,r.jsxs)("main",{className:"col-span-12 md:col-span-10 space-y-6",children:[(0,r.jsxs)("div",{className:"grid gap-4 md:grid-cols-4",children:[(0,r.jsx)(n,{title:"총 측정 건수",value:eH.totalCount,sub:"".concat(K.start," ~ ").concat(K.end)}),(0,r.jsx)(n,{title:"이번 달 측정",value:eH.monthCount}),(0,r.jsx)(n,{title:"기준 초과",value:eH.exceed,sub:"".concat(K.customer," / ").concat(K.item)}),(0,r.jsx)(n,{title:"평균 농도",value:eH.avg,sub:(null==eM?void 0:eM.unit)||"mg/S㎥"})]}),(0,r.jsxs)("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-3",children:[(0,r.jsxs)("div",{className:"flex flex-wrap items-center gap-3",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("label",{className:"text-sm",children:"차트 유형"}),(0,r.jsxs)(o.Z,{className:"min-w-[120px] bg-white dark:bg-gray-700",value:H,onChange:e=>Y(e.target.value),children:[(0,r.jsx)("option",{value:"line",children:"Line"}),(0,r.jsx)("option",{value:"bar",children:"Bar"}),(0,r.jsx)("option",{value:"scatter",children:"Scatter"})]})]}),(0,r.jsxs)("label",{className:"text-sm inline-flex items-center gap-2",children:[(0,r.jsx)("input",{type:"checkbox",className:"accent-blue-500",checked:V,onChange:e=>W(e.target.checked)})," 30% 기준선"]}),(0,r.jsxs)("label",{className:"text-sm inline-flex items-center gap-2",children:[(0,r.jsx)("input",{type:"checkbox",className:"accent-blue-500",checked:J,onChange:e=>$(e.target.checked)})," 이동평균선"]}),"scatter"===H&&(0,r.jsxs)("label",{className:"text-sm inline-flex items-center gap-2",children:[(0,r.jsx)("input",{type:"checkbox",className:"accent-blue-500",checked:q,onChange:e=>G(e.target.checked)})," 평균선"]})]}),(0,r.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,r.jsx)(x.Z,{variant:"secondary",onClick:async()=>{if(!eA||!(null==eM?void 0:eM.key)){alert("고객사와 항목을 선택해주세요.");return}try{var e,t,a,r,n,l,s;ed(!0);let i=await Q({customer_id:eA,stack:(null===(e=eR[0])||void 0===e?void 0:e.name)||"dummy",item_key:eM.key,periods:30});if(i){er(i.predictions);let e="\uD83E\uDD16 AI 예측 완료\n\n\uD83D\uDCCA 예측 정보:\n• Prophet AutoML 모델 기반\n• 고객사 전체 굴뚝 데이터 학습\n• 과거 패턴 및 계절성 반영\n• 30일 미래 예측\n\n\uD83D\uDCC8 모델 상세 정보:\n• 모델: ".concat(i.model_info.model_type," (Meta Research)\n• 학습 데이터: ").concat(i.training_samples,"건\n• 예측 기간: 30일\n\n\uD83C\uDFAF 모델 정확도:\n• RMSE: ").concat((null===(a=i.accuracy_metrics)||void 0===a?void 0:null===(t=a.rmse)||void 0===t?void 0:t.toFixed(2))||"N/A"," mg/S㎥\n• MAE: ").concat((null===(n=i.accuracy_metrics)||void 0===n?void 0:null===(r=n.mae)||void 0===r?void 0:r.toFixed(2))||"N/A"," mg/S㎥\n• R\xb2: ").concat((null===(s=i.accuracy_metrics)||void 0===s?void 0:null===(l=s.r2)||void 0===l?void 0:l.toFixed(3))||"N/A","\n\n\uD83D\uDCA1 설명:\nR\xb2 값이 높을수록 모델의 설명력이 높으며,\nRMSE와 MAE는 예측 오차를 나타냅니다.\n\n✨ 차트의 초록색 예측선에 마우스를 올려\n각 예측 포인트의 상세 정보를 확인하세요!");el(e),ei(!0)}else el("❌ 예측 실패\n\n".concat(ee||"알 수 없는 오류가 발생했습니다.","\n\n해당 고객사/항목의 측정 데이터가 부족할 수 있습니다.\n(최소 10개 이상 필요)")),ei(!0)}catch(e){el("❌ 예측 실패\n\n".concat(e.message||"예측 중 오류가 발생했습니다.","\n\n해당 고객사/항목의 측정 데이터가 부족할 수 있습니다.")),ei(!0)}finally{ed(!1)}},disabled:eo,title:"고객사 전체 굴뚝 데이터를 사용하여 AI 예측을 수행합니다",children:eo?"예측 생성 중...":"AutoML 예측"}),(0,r.jsx)(x.Z,{variant:"primary",onClick:async()=>{if(!eA||!(null==eM?void 0:eM.key)){alert("고객사와 항목을 선택해주세요.");return}eu(!0),eg("\uD83D\uDD04 인사이트 보고서 생성 중...\n\n예상 소요 시간: 약 10-15초\n\nAI 모델 학습 및 분석을 진행하고 있습니다."),ex(!0);try{var e,t;let a=null;if(e$.current)try{a=e$.current.toDataURL("image/png").split(",")[1]}catch(e){}let r=await fetch("http://localhost:8000/api/predict/insight",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({customer_id:eA,stack:(null===(e=eR[0])||void 0===e?void 0:e.name)||"dummy",item_key:eM.key,item_name:eM.name,periods:30,chart_image:a,user_id:null==k?void 0:null===(t=k.user)||void 0===t?void 0:t.id})});if(!r.ok)throw Error("보고서 생성 실패");let n=await r.json();if(!(n&&"object"==typeof n&&"string"==typeof n.pdf_base64&&n.pdf_base64.length>100&&Array.isArray(n.predictions)&&n.model_info&&n.insight_report))throw Error("백엔드에서 유효하지 않은 응답을 받았습니다. PDF 데이터가 없습니다.");if(!function(e){if(!e)throw Error("PDF 데이터가 없습니다.");if(e.length<100)throw Error("PDF 데이터가 너무 짧습니다. 유효하지 않은 데이터일 수 있습니다.");if(!/^[A-Za-z0-9+/]*={0,2}$/.test(e))throw Error("유효하지 않은 Base64 형식입니다.")}(n.pdf_base64),er(n.predictions),eg("✅ 보고서 생성 완료!\n\n새 탭에서 PDF 보고서를 여시겠습니까?"),confirm("\uD83D\uDCCA 보고서가 생성되었습니다.\n\nPDF를 새 탭에서 여시겠습니까?"))try{let e=atob(n.pdf_base64),t=Array(e.length);for(let a=0;a<e.length;a++)t[a]=e.charCodeAt(a);let a=new Uint8Array(t),r=new Blob([a],{type:"application/pdf"}),l=URL.createObjectURL(r),s=window.open(l,"_blank");(!s||s.closed||void 0===s.closed)&&alert("⚠️ 팝업이 차단되었습니다.\n\n브라우저 주소창 오른쪽의 팝업 차단 아이콘을 클릭하여\n이 사이트의 팝업을 허용해주세요.")}catch(e){alert("PDF 표시 중 오류가 발생했습니다.")}}catch(e){alert("❌ 보고서 생성 실패\n\n".concat(e.message))}finally{eu(!1)}},disabled:ec,title:"AI 기반 예측 인사이트 보고서를 생성합니다",children:ec?"보고서 생성 중...":"인사이트 보고서"}),(0,r.jsx)(x.Z,{variant:"secondary",onClick:()=>{try{let e=eU.map(e=>{var t,a,r,n,l,s,i,o;return{measuredAt:e.measuredAt,customer:(null===(t=e.customer)||void 0===t?void 0:t.name)||"",stackId:(null===(a=e.stack)||void 0===a?void 0:a.id)||e.stackId||"",stackName:(null===(r=e.stack)||void 0===r?void 0:r.name)||e.stackName||"",itemName:(null===(n=e.item)||void 0===n?void 0:n.name)||"",itemKey:e.itemKey,unit:null!==(i=null===(l=e.item)||void 0===l?void 0:l.unit)&&void 0!==i?i:"",limit:null!==(o=null===(s=e.item)||void 0===s?void 0:s.limit)&&void 0!==o?o:"",value:e.value}}).map(e=>[e.measuredAt,e.customer,e.stackId,e.stackName,e.itemName,e.itemKey,e.unit,e.limit,e.value].map(e=>null!=e?String(e).replaceAll('"','""'):"").map(e=>e.includes(",")||e.includes('"')?'"'.concat(e,'"'):e).join(",")).join("\n"),t=new Blob(["\uFEFFmeasuredAt,customer,stackId,stackName,itemName,itemKey,unit,limit,value\n"+e],{type:"text/csv;charset=utf-8;"}),a=URL.createObjectURL(t),r=document.createElement("a");r.href=a,r.download="boaz-data-".concat(K.item,"-").concat(K.start,"-").concat(K.end,".csv"),r.click(),URL.revokeObjectURL(a)}catch(e){}},children:"엑셀 다운로드"}),(0,r.jsx)(x.Z,{variant:"secondary",onClick:()=>{let e=e$.current;if(!e)return;let t=e.toDataURL("image/png"),a=window.open("","print");if(!a)return;let r="월별 농도 추이 - ".concat(K.item),n="".concat(K.start," ~ ").concat(K.end);a.document.write("<!doctype html><html><head><title>".concat(r,'</title>\n      <style>\n        body{margin:24px;padding:0;background:#fff;color:#111;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}\n        .header{margin-bottom:12px}\n        .title{font-size:18px;font-weight:600}\n        .period{font-size:12px;color:#555}\n        .imgwrap{display:flex;justify-content:center;align-items:center}\n        img{max-width:100%;}\n      </style>\n      </head><body>\n      <div class="header"><div class="title">').concat(r,'</div><div class="period">').concat(n,'</div></div>\n      <div class="imgwrap"><img src="').concat(t,'"/></div>\n      </body></html>')),a.document.close(),a.focus(),a.print()},children:"그래프 PDF"})]})]}),0===eB.data.length?(0,r.jsx)("div",{className:"rounded-lg border p-6 text-sm text-gray-500 bg-white/50 dark:bg-white/5",children:"표시할 데이터가 없습니다. 기간과 항목을 조정해 보세요."}):(0,r.jsx)(s,{labels:eB.labels,data:eB.data,limit:eB.limit,title:"월별 농도 추이 - ".concat(K.item),chartType:H,showLimit30:V,showPrediction:J,showAverage:q,xTimes:eY,pointStacks:eV,pointPayloads:"scatter"===H?null==eK?void 0:eK.payloads:void 0,height:560,exportRef:e$,monthTicks:"scatter"===H?eW:void 0,monthTickLabels:"scatter"===H?eJ:void 0,aiPredictions:ea.length>0?ea:void 0})]})]}),(0,r.jsx)(d,{open:ep,onClose:()=>ef(!1),summaries:ez,loading:eZ,initialSelectedNames:I,onApply:e=>{T(e),ef(!1)}}),es&&(0,r.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",onClick:()=>ei(!1),children:(0,r.jsxs)("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-8 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto shadow-2xl",onClick:e=>e.stopPropagation(),children:[(0,r.jsx)("pre",{className:"whitespace-pre-wrap text-base font-sans leading-relaxed text-gray-800 dark:text-gray-200",children:en}),(0,r.jsx)("div",{className:"mt-8 flex justify-end",children:(0,r.jsx)(x.Z,{variant:"primary",onClick:()=>ei(!1),children:"확인"})})]})}),eh&&(0,r.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",onClick:()=>ex(!1),children:(0,r.jsxs)("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto",onClick:e=>e.stopPropagation(),children:[(0,r.jsx)("pre",{className:"whitespace-pre-wrap text-sm font-sans",children:em}),(0,r.jsx)("div",{className:"mt-6 flex justify-end",children:(0,r.jsx)(x.Z,{variant:"primary",onClick:()=>ex(!1),children:"확인"})})]})})]}):(0,r.jsx)("div",{className:"flex items-center justify-center h-screen",children:(0,r.jsx)("div",{className:"text-lg text-red-600",children:"조직 정보를 불러올 수 없습니다."})})}},6334:function(e,t,a){"use strict";a.d(t,{Z:function(){return s}});var r=a(7437);a(2265);let n={primary:"bg-black text-white hover:bg-black/90 dark:bg-white dark:text-black dark:hover:bg-white/90",secondary:"border border-gray-300 text-gray-900 hover:bg-gray-50 dark:border-white/20 dark:text-white dark:hover:bg-white/10",ghost:"text-gray-700 hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-white/10"},l={sm:"h-8 px-3 text-sm",md:"h-10 px-4 text-sm",lg:"h-11 px-5 text-base"};function s(e){let{variant:t="primary",size:a="md",className:s="",...i}=e;return(0,r.jsx)("button",{className:"".concat("inline-flex items-center justify-center rounded-md font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none"," ").concat(n[t]," ").concat(l[a]," ").concat(s),...i})}},2827:function(e,t,a){"use strict";a.d(t,{Z:function(){return n}});var r=a(7437);function n(e){let{className:t="",...a}=e;return(0,r.jsx)("input",{className:"".concat("rounded-md border bg-transparent px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:border-white/20"," ").concat(t),...a})}a(2265)},6819:function(e,t,a){"use strict";a.d(t,{Z:function(){return n}});var r=a(7437);function n(e){let{className:t="",children:a,...n}=e;return(0,r.jsx)("select",{className:"".concat("w-full rounded-md border bg-transparent px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:border-white/20"," ").concat(t),...n,children:a})}a(2265)},2891:function(e,t,a){"use strict";a.d(t,{OrganizationProvider:function(){return i},o:function(){return o}});var r=a(7437),n=a(2265),l=a(605);let s=(0,n.createContext)(void 0);function i(e){var t,a,i;let{children:o}=e,{data:d,status:c}=(0,l.useSession)(),[u,m]=(0,n.useState)(null),[g,h]=(0,n.useState)([]),[x,p]=(0,n.useState)(!0),f=(null==d?void 0:null===(t=d.user)||void 0===t?void 0:t.role)==="SUPER_ADMIN",v=null==d?void 0:null===(a=d.user)||void 0===a?void 0:a.role,y=null==d?void 0:null===(i=d.user)||void 0===i?void 0:i.organizationId,b="CUSTOMER_ADMIN"===v||"CUSTOMER_USER"===v;(0,n.useEffect)(()=>{if("loading"!==c){if(!d||b){p(!1);return}f&&sessionStorage.getItem("viewAsOrganization"),f?k():y?w(y):p(!1)}},[d,c,f,y,b]),(0,n.useEffect)(()=>{if(!f)return;let e=sessionStorage.getItem("viewAsOrganization");e&&(null==u?void 0:u.id)!==e&&k();let t=setInterval(()=>{let e=sessionStorage.getItem("viewAsOrganization");if(e&&(null==u?void 0:u.id)!==e)k();else if(!e&&u){let e=localStorage.getItem("selectedOrgId");e&&u.id!==e&&k()}},500);return()=>clearInterval(t)},[f,u]);let k=async()=>{try{let e=await fetch("/api/organizations?status=APPROVED"),t=await e.json();if(e.ok){let e=t.organizations||[];h(e);let a=sessionStorage.getItem("viewAsOrganization");if(a){let t=e.find(e=>e.id===a);if(t){m(t);return}}let r=localStorage.getItem("selectedOrgId");if(r){let t=e.find(e=>e.id===r);t?m(t):e.length>0&&m(e[0])}else e.length>0&&m(e[0])}}catch(e){}finally{p(!1)}},w=async e=>{try{let t=await fetch("/api/organizations/".concat(e)),a=await t.json();if(t.ok){let e=a.organization;h([e]),m(e)}}catch(e){}finally{p(!1)}};return(0,r.jsx)(s.Provider,{value:{selectedOrg:u,setSelectedOrg:e=>{m(e),e?localStorage.setItem("selectedOrgId",e.id):localStorage.removeItem("selectedOrgId")},organizations:g,loading:x,isSuperAdmin:f},children:o})}function o(){let e=(0,n.useContext)(s);if(void 0===e)throw Error("useOrganization must be used within OrganizationProvider");return e}},4755:function(e,t,a){"use strict";a.d(t,{n:function(){return s}});var r=a(2265),n=a(2891),l=a(605);function s(){var e,t;let[a,s]=(0,r.useState)([]),{selectedOrg:i}=(0,n.o)(),{data:o}=(0,l.useSession)(),d=null==o?void 0:null===(e=o.user)||void 0===e?void 0:e.role,c=null==o?void 0:null===(t=o.user)||void 0===t?void 0:t.customerId,u="CUSTOMER_ADMIN"===d||"CUSTOMER_USER"===d,m=(0,r.useCallback)(()=>{if(u&&c){fetch("/api/customers/".concat(c)).then(e=>e.json()).then(e=>{let t=e.customer||e.data;s(t?[t]:[])}).catch(e=>{s([])});return}if(!(null==i?void 0:i.id)){s([]);return}let e=new URLSearchParams;e.append("organizationId",i.id),e.append("tab","all"),fetch("/api/customers?".concat(e.toString())).then(e=>e.json()).then(e=>{s(e.customers||e.data||[])}).catch(e=>{s([])})},[i,u,c]);return(0,r.useEffect)(()=>{m()},[m]),{list:a,refetch:m}}},8776:function(e,t,a){"use strict";a.d(t,{F:function(){return s},r:function(){return i}});var r=a(2265),n=a(2891),l=a(605);function s(){let[e,t]=(0,r.useState)([]);return(0,r.useEffect)(()=>{let e=!0;return fetch("/api/items").then(e=>e.json()).then(a=>{e&&t(a.data||[])}).catch(()=>{e&&t([])}),()=>{e=!1}},[]),{items:e}}function i(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{customerId:a,stack:s,stacks:i,itemKey:o,page:d=1,pageSize:c=50,sort:u,start:m,end:g}=t,[h,x]=(0,r.useState)([]),[p,f]=(0,r.useState)(0),{selectedOrg:v}=(0,n.o)(),{data:y}=(0,l.useSession)(),b=null==y?void 0:null===(e=y.user)||void 0===e?void 0:e.role,k="CUSTOMER_ADMIN"===b||"CUSTOMER_USER"===b;(0,r.useEffect)(()=>{let e=!0,t=new AbortController;if(!k&&!(null==v?void 0:v.id)){x([]);return}let r=new URLSearchParams;return a&&r.set("customerId",a),i&&i.length?i.forEach(e=>r.append("stack",e)):s&&r.set("stack",s),o&&r.set("itemKey",o),m&&r.set("start",m),g&&r.set("end",g),(null==v?void 0:v.id)&&r.set("organizationId",v.id),fetch("/api/measurements?".concat(r.toString()),{signal:t.signal}).then(e=>e.json()).then(t=>{e&&x(Array.isArray(t.measurements)?t.measurements:Array.isArray(t.data)?t.data:[])}).catch(t=>{t.name,e&&x([])}),()=>{e=!1,t.abort()}},[a,s,(i||[]).join("|"),o,m,g,p,v,k]);let w=(0,r.useMemo)(()=>{if(!u)return h;let{key:e,dir:t}=u,a=[...h];return a.sort((a,r)=>{let n=a[e],l=r[e];return n<l?"asc"===t?-1:1:n>l?"asc"===t?1:-1:0}),a},[h,u]),j=w.length,N=(d-1)*c;return{data:c>=999999?w:w.slice(N,N+c),total:j,page:d,pageSize:c,mutate:()=>f(e=>e+1)}}},9548:function(e,t,a){"use strict";a.d(t,{D:function(){return l}});var r=a(2265),n=a(2891);function l(e){let[t,a]=(0,r.useState)([]),{selectedOrg:l}=(0,n.o)();return(0,r.useEffect)(()=>{let t=!0;if(!(null==l?void 0:l.id)){a([]);return}let r=new URLSearchParams;return e&&r.set("customerId",e),r.set("organizationId",l.id),fetch("/api/stacks?".concat(r.toString())).then(e=>e.json()).then(e=>{let r=(e.stacks||e.data||[]).filter(e=>!1!==e.isActive);t&&a(r)}).catch(e=>{t&&a([])}),()=>{t=!1}},[e,l]),{list:t}}}},function(e){e.O(0,[605,2971,2117,1744],function(){return e(e.s=2861)}),_N_E=e.O()}]);
(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8252],{1929:function(e,t,a){Promise.resolve().then(a.bind(a,4522))},9376:function(e,t,a){"use strict";var s=a(5475);a.o(s,"useParams")&&a.d(t,{useParams:function(){return s.useParams}}),a.o(s,"usePathname")&&a.d(t,{usePathname:function(){return s.usePathname}}),a.o(s,"useRouter")&&a.d(t,{useRouter:function(){return s.useRouter}}),a.o(s,"useSearchParams")&&a.d(t,{useSearchParams:function(){return s.useSearchParams}})},4522:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return c}});var s=a(7437),r=a(2265),n=a(605),l=a(9376);function i(e){let{isOpen:t,onClose:a,onSuccess:l}=e,{data:i}=(0,n.useSession)(),[c,d]=(0,r.useState)(""),[x,o]=(0,r.useState)([]),[m,u]=(0,r.useState)(null),[h,g]=(0,r.useState)(""),[p,y]=(0,r.useState)(""),[b,N]=(0,r.useState)(!1),[j,f]=(0,r.useState)(!1);(0,r.useEffect)(()=>{if(c.length>=2){let e=setTimeout(()=>{v()},300);return()=>clearTimeout(e)}o([])},[c]);let v=async()=>{try{f(!0);let e=await fetch("/api/companies/search?q=".concat(encodeURIComponent(c),"&type=organization")),t=await e.json();e.ok&&o(t.results||[])}catch(e){}finally{f(!1)}},w=async()=>{if(!m){alert("환경측정기업을 선택해주세요.");return}try{var e;N(!0);let t=null==i?void 0:null===(e=i.user)||void 0===e?void 0:e.customerId,a=await fetch("/api/connection-requests/customer-to-org",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({customerId:t,organizationId:m.id,contractStartDate:h||null,contractEndDate:p||null})}),s=await a.json();a.ok?(alert("연결 요청이 전송되었습니다."),l(),D()):alert(s.error||"요청 전송 실패")}catch(e){alert("요청 전송 중 오류가 발생했습니다.")}finally{N(!1)}},D=()=>{d(""),o([]),u(null),g(""),y(""),a()};return t?(0,s.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,s.jsxs)("div",{className:"bg-white rounded-lg p-6 w-[600px] max-h-[80vh] overflow-y-auto",children:[(0,s.jsx)("h2",{className:"text-xl font-bold mb-4",children:"환경측정기업 연결 요청"}),m?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:"mb-4 p-4 bg-gray-50 rounded",children:(0,s.jsxs)("div",{className:"flex justify-between items-start",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"font-medium text-lg",children:m.name}),(0,s.jsx)("div",{className:"text-sm text-gray-500 mt-1",children:m.businessNumber}),(0,s.jsx)("div",{className:"text-sm text-gray-500",children:m.phone}),(0,s.jsx)("div",{className:"text-xs text-gray-400 mt-1",children:m.address})]}),(0,s.jsx)("button",{onClick:()=>u(null),className:"text-gray-400 hover:text-gray-600",children:"✕"})]})}),(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"계약 기간 (선택사항)"}),(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-xs text-gray-500 mb-1",children:"시작일"}),(0,s.jsx)("input",{type:"date",value:h,onChange:e=>g(e.target.value),className:"w-full border rounded px-3 py-2"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-xs text-gray-500 mb-1",children:"종료일"}),(0,s.jsx)("input",{type:"date",value:p,onChange:e=>y(e.target.value),className:"w-full border rounded px-3 py-2"})]})]})]}),(0,s.jsx)("div",{className:"mb-4 p-3 bg-blue-50 rounded text-sm text-blue-800",children:"\uD83D\uDCA1 연결 요청을 전송하면 환경측정기업 관리자가 승인할 수 있습니다."})]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"환경측정기업 검색"}),(0,s.jsx)("input",{type:"text",placeholder:"기업명 또는 사업자등록번호 입력",value:c,onChange:e=>d(e.target.value),className:"w-full border rounded px-3 py-2"}),j&&(0,s.jsx)("p",{className:"text-sm text-gray-500 mt-2",children:"검색 중..."})]}),x.length>0&&(0,s.jsx)("div",{className:"mb-4 border rounded max-h-60 overflow-y-auto",children:x.map(e=>(0,s.jsxs)("div",{onClick:()=>u(e),className:"p-3 hover:bg-gray-50 cursor-pointer border-b last:border-b-0",children:[(0,s.jsx)("div",{className:"font-medium",children:e.name}),(0,s.jsxs)("div",{className:"text-sm text-gray-500",children:[e.businessNumber," | ",e.phone]}),(0,s.jsx)("div",{className:"text-xs text-gray-400",children:e.address})]},e.id))}),c.length>=2&&!j&&0===x.length&&(0,s.jsx)("p",{className:"text-sm text-gray-500 mb-4",children:"검색 결과가 없습니다."})]}),(0,s.jsxs)("div",{className:"flex gap-3",children:[(0,s.jsx)("button",{onClick:D,className:"flex-1 bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700",disabled:b,children:"취소"}),m&&(0,s.jsx)("button",{onClick:w,className:"flex-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:bg-gray-400",disabled:b,children:b?"전송 중...":"연결 요청"})]})]})}):null}function c(){var e;let{data:t,status:a}=(0,n.useSession)(),c=(0,l.useRouter)(),[d,x]=(0,r.useState)([]),[o,m]=(0,r.useState)(!0),[u,h]=(0,r.useState)(""),[g,p]=(0,r.useState)("ALL"),[y,b]=(0,r.useState)(!1);(0,r.useEffect)(()=>{if("unauthenticated"===a){c.push("/login");return}if(null==t?void 0:t.user){let e=t.user.role;if("CUSTOMER_ADMIN"!==e&&"CUSTOMER_USER"!==e&&"SUPER_ADMIN"!==e){c.push("/dashboard");return}N()}},[t,a,c]);let N=async()=>{try{var e;m(!0);let a=null==t?void 0:null===(e=t.user)||void 0===e?void 0:e.customerId,s=await fetch("/api/connections/by-customer?customerId=".concat(a)),r=await s.json();s.ok&&x(r.connections||[])}catch(e){}finally{m(!1)}},j=async e=>{if(confirm("이 연결 초대를 승인하시겠습니까?"))try{let t=await fetch("/api/customer-organizations/".concat(e,"/approve"),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({})});if(t.ok)alert("연결이 승인되었습니다."),N();else{let e=await t.json();alert(e.error||"승인 실패")}}catch(e){alert("승인 중 오류가 발생했습니다.")}},f=async e=>{if(confirm("이 연결 초대를 거부하시겠습니까?"))try{let t=await fetch("/api/customer-organizations/".concat(e,"/reject"),{method:"PATCH"});if(t.ok)alert("연결이 거부되었습니다."),N();else{let e=await t.json();alert(e.error||"거부 실패")}}catch(e){alert("거부 중 오류가 발생했습니다.")}},v=async e=>{if(confirm("이 환경측정기업과의 연결을 해제하시겠습니까? 기존 데이터는 읽기 전용으로 유지됩니다."))try{let t=await fetch("/api/customer-organizations/".concat(e,"/disconnect"),{method:"POST"});if(t.ok)alert("연결이 해제되었습니다."),N();else{let e=await t.json();alert(e.error||"연결 해제 실패")}}catch(e){alert("연결 해제 중 오류가 발생했습니다.")}},w=d.filter(e=>{let t=e.organization.name.toLowerCase().includes(u.toLowerCase())||e.organization.businessNumber.includes(u),a="ALL"===g||e.status===g;return t&&a}),D=e=>(0,s.jsx)("span",{className:"px-2 py-1 rounded text-xs font-medium ".concat({PENDING:"bg-yellow-100 text-yellow-800",APPROVED:"bg-green-100 text-green-800",REJECTED:"bg-red-100 text-red-800",DISCONNECTED:"bg-gray-100 text-gray-800"}[e]),children:{PENDING:"대기중",APPROVED:"승인됨",REJECTED:"거부됨",DISCONNECTED:"연결해제"}[e]}),C=e=>"CUSTOMER"===e?(0,s.jsx)("span",{className:"text-xs text-blue-600",children:"우리가 요청"}):(0,s.jsx)("span",{className:"text-xs text-purple-600",children:"기업 초대"}),E=null==t?void 0:null===(e=t.user)||void 0===e?void 0:e.role,S="CUSTOMER_ADMIN"===E||"SUPER_ADMIN"===E;return o?(0,s.jsx)("div",{className:"flex justify-center items-center h-64",children:(0,s.jsx)("div",{className:"text-gray-500",children:"로딩 중..."})}):(0,s.jsxs)("section",{className:"space-y-3",children:[(0,s.jsx)("div",{className:"rounded-lg border bg-white/50 dark:bg-white/5 p-2.5",children:(0,s.jsxs)("div",{className:"flex flex-wrap items-end gap-2",children:[(0,s.jsx)("h1",{className:"text-lg font-semibold whitespace-nowrap mb-1.5",children:"환경측정기업 관리"}),(0,s.jsx)("span",{className:"text-gray-300 dark:text-gray-600 mb-1.5",children:"|"}),(0,s.jsxs)("div",{className:"flex flex-col",style:{width:"300px",minWidth:"300px"},children:[(0,s.jsx)("label",{className:"text-xs text-gray-600 dark:text-gray-400 mb-0.5",children:"검색"}),(0,s.jsx)("input",{type:"text",placeholder:"기업명 또는 사업자등록번호 검색",value:u,onChange:e=>h(e.target.value),className:"text-sm h-8 px-3 border rounded dark:bg-gray-800 dark:border-gray-700"})]}),(0,s.jsxs)("div",{className:"flex flex-col",style:{width:"140px",minWidth:"140px"},children:[(0,s.jsx)("label",{className:"text-xs text-gray-600 dark:text-gray-400 mb-0.5",children:"상태"}),(0,s.jsxs)("select",{value:g,onChange:e=>p(e.target.value),className:"text-sm h-8 px-2 border rounded dark:bg-gray-800 dark:border-gray-700",children:[(0,s.jsx)("option",{value:"ALL",children:"전체"}),(0,s.jsx)("option",{value:"PENDING",children:"대기중"}),(0,s.jsx)("option",{value:"APPROVED",children:"승인됨"}),(0,s.jsx)("option",{value:"REJECTED",children:"거부됨"}),(0,s.jsx)("option",{value:"DISCONNECTED",children:"연결해제"})]})]}),S&&(0,s.jsx)("button",{onClick:()=>b(!0),className:"ml-auto mb-1.5 bg-blue-600 text-white px-3 py-1.5 text-sm rounded hover:bg-blue-700",children:"+ 환경측정기업 연결 요청"})]})}),(0,s.jsx)("div",{className:"hidden md:block rounded-lg border bg-white dark:bg-gray-900",children:(0,s.jsx)("div",{className:"overflow-x-auto",children:(0,s.jsxs)("table",{className:"min-w-full divide-y divide-gray-200",children:[(0,s.jsx)("thead",{className:"bg-gray-50",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"상태"}),(0,s.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"요청구분"}),(0,s.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"기업명"}),(0,s.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"사업자등록번호"}),(0,s.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"연락처"}),(0,s.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"계약기간"}),(0,s.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"잔여일"}),(0,s.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"사업장"}),(0,s.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"액션"})]})}),(0,s.jsx)("tbody",{className:"bg-white divide-y divide-gray-200",children:0===w.length?(0,s.jsx)("tr",{children:(0,s.jsx)("td",{colSpan:9,className:"px-6 py-4 text-center text-gray-500",children:"연결된 환경측정기업이 없습니다."})}):w.map(e=>(0,s.jsxs)("tr",{className:"hover:bg-gray-50",children:[(0,s.jsx)("td",{className:"px-6 py-4 whitespace-nowrap",children:D(e.status)}),(0,s.jsx)("td",{className:"px-6 py-4 whitespace-nowrap",children:C(e.requestedBy)}),(0,s.jsx)("td",{className:"px-6 py-4 whitespace-nowrap font-medium text-gray-900",children:e.organization.name}),(0,s.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-gray-500",children:e.organization.businessNumber}),(0,s.jsxs)("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:[(0,s.jsx)("div",{children:e.organization.phone}),(0,s.jsx)("div",{className:"text-xs text-gray-400",children:e.organization.email})]}),(0,s.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:e.contractStartDate&&e.contractEndDate?(0,s.jsxs)("div",{children:[new Date(e.contractStartDate).toLocaleDateString()," ~ ",new Date(e.contractEndDate).toLocaleDateString()]}):"-"}),(0,s.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:null!==e.daysRemaining?(0,s.jsx)("span",{className:"px-2 py-1 rounded text-xs font-medium ".concat(e.daysRemaining<0?"bg-red-100 text-red-700":e.daysRemaining<=7?"bg-red-50 text-red-600":e.daysRemaining<=28?"bg-yellow-50 text-yellow-700":"bg-green-50 text-green-700"),children:e.daysRemaining<0?"만료 ".concat(Math.abs(e.daysRemaining),"일"):"".concat(e.daysRemaining,"일")}):"-"}),(0,s.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:e.siteType||"-"}),(0,s.jsxs)("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:["PENDING"===e.status&&"ORGANIZATION"===e.requestedBy&&S&&(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)("button",{onClick:()=>j(e.id),className:"text-green-600 hover:text-green-900",children:"승인"}),(0,s.jsx)("button",{onClick:()=>f(e.id),className:"text-red-600 hover:text-red-900",children:"거부"})]}),"APPROVED"===e.status&&(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)("button",{onClick:()=>c.push("/customer/organizations/".concat(e.organization.id)),className:"text-blue-600 hover:text-blue-900",children:"상세"}),S&&(0,s.jsx)("button",{onClick:()=>v(e.id),className:"text-red-600 hover:text-red-900",children:"연결해제"})]}),"PENDING"===e.status&&"CUSTOMER"===e.requestedBy&&(0,s.jsx)("span",{className:"text-gray-500",children:"대기중"})]})]},e.id))})]})})}),(0,s.jsx)("div",{className:"md:hidden space-y-3",children:0===w.length?(0,s.jsx)("div",{className:"rounded-lg border bg-white/50 dark:bg-white/5 p-6 text-center text-gray-500",children:"연결된 환경측정기업이 없습니다."}):w.map(e=>(0,s.jsxs)("div",{className:"rounded-lg border bg-white/50 dark:bg-white/5 p-4 space-y-2",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[D(e.status),C(e.requestedBy)]}),(0,s.jsxs)("div",{className:"grid grid-cols-1 gap-2 text-sm",children:[(0,s.jsx)("div",{className:"font-medium text-lg",children:e.organization.name}),(0,s.jsxs)("div",{children:[(0,s.jsx)("span",{className:"text-gray-500",children:"\uD83D\uDCBC 사업자:"})," ",e.organization.businessNumber]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("span",{className:"text-gray-500",children:"\uD83D\uDCDE 연락처:"})," ",e.organization.phone]}),(0,s.jsxs)("div",{className:"text-xs text-gray-500",children:["\uD83D\uDCE7 ",e.organization.email]}),e.contractStartDate&&e.contractEndDate&&(0,s.jsxs)("div",{children:[(0,s.jsx)("span",{className:"text-gray-500",children:"\uD83D\uDCC5 계약:"})," ",new Date(e.contractStartDate).toLocaleDateString()," ~ ",new Date(e.contractEndDate).toLocaleDateString()]}),null!==e.daysRemaining&&(0,s.jsxs)("div",{children:[(0,s.jsx)("span",{className:"text-gray-500",children:"⏱️ 잔여:"})," ",(0,s.jsx)("span",{className:"px-2 py-1 rounded text-xs font-medium ".concat(e.daysRemaining<0?"bg-red-100 text-red-700":e.daysRemaining<=7?"bg-red-50 text-red-600":e.daysRemaining<=28?"bg-yellow-50 text-yellow-700":"bg-green-50 text-green-700"),children:e.daysRemaining<0?"만료 ".concat(Math.abs(e.daysRemaining),"일"):"".concat(e.daysRemaining,"일")})]}),(0,s.jsxs)("div",{className:"flex flex-col gap-2 pt-2",children:["PENDING"===e.status&&"ORGANIZATION"===e.requestedBy&&S&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("button",{onClick:()=>j(e.id),className:"w-full px-3 py-2 bg-green-500 text-white hover:bg-green-600 rounded text-sm",children:"승인"}),(0,s.jsx)("button",{onClick:()=>f(e.id),className:"w-full px-3 py-2 bg-gray-500 text-white hover:bg-gray-600 rounded text-sm",children:"거부"})]}),"APPROVED"===e.status&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("button",{onClick:()=>c.push("/customer/organizations/".concat(e.organization.id)),className:"w-full px-3 py-2 bg-blue-500 text-white hover:bg-blue-600 rounded text-sm",children:"상세"}),S&&(0,s.jsx)("button",{onClick:()=>v(e.id),className:"w-full px-3 py-2 bg-gray-500 text-white hover:bg-gray-600 rounded text-sm",children:"연결해제"})]}),"PENDING"===e.status&&"CUSTOMER"===e.requestedBy&&(0,s.jsx)("div",{className:"text-center text-gray-500",children:"대기중"})]})]})]},e.id))}),(0,s.jsx)(i,{isOpen:y,onClose:()=>b(!1),onSuccess:N})]})}}},function(e){e.O(0,[605,2971,2117,1744],function(){return e(e.s=1929)}),_N_E=e.O()}]);
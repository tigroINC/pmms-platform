"use strict";(()=>{var e={};e.id=8175,e.ids=[8175],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},92609:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>l,patchFetch:()=>p,requestAsyncStorage:()=>C,routeModule:()=>R,serverHooks:()=>_,staticGenerationAsyncStorage:()=>T});var a={};r.r(a),r.d(a,{GET:()=>u});var n=r(49303),i=r(88716),s=r(60670),o=r(87070),c=r(20728);async function u(e){try{let e=new Date;e.setHours(0,0,0,0);let t=await c._.customerOrganization.findMany({where:{isActive:!0,status:"APPROVED",contractEndDate:{not:null}},include:{customer:{select:{id:!0,name:!0}},organization:{select:{id:!0,name:!0,users:{where:{role:"ORG_ADMIN",isActive:!0},select:{id:!0}}}}}}),r=[];for(let a of t){if(!a.contractEndDate)continue;let t=new Date(a.contractEndDate);t.setHours(0,0,0,0);let n=t.getTime()-e.getTime(),i=Math.ceil(n/864e5),s=null,o=!1,u=null;if(30!==i||a.notified30Days?21!==i||a.notified21Days?14!==i||a.notified14Days?7!==i||a.notified7Days?i>=1&&i<=6?(s="CONTRACT_EXPIRY_DAILY",o=!0):0!==i||a.notifiedExpiry||(s="CONTRACT_EXPIRED",o=!0,u="notifiedExpiry"):(s="CONTRACT_EXPIRY_7",o=!0,u="notified7Days"):(s="CONTRACT_EXPIRY_14",o=!0,u="notified14Days"):(s="CONTRACT_EXPIRY_21",o=!0,u="notified21Days"):(s="CONTRACT_EXPIRY_30",o=!0,u="notified30Days"),o&&s){for(let e of a.organization.users)await c._.notification.create({data:{userId:e.id,type:s,title:d(s,i),message:function(e,t,r,a){let n=a.toLocaleDateString("ko-KR");switch(e){case"CONTRACT_EXPIRY_30":case"CONTRACT_EXPIRY_21":case"CONTRACT_EXPIRY_14":case"CONTRACT_EXPIRY_7":case"CONTRACT_EXPIRY_DAILY":return`${t}의 계약이 ${r}일 후 만료됩니다. (만료일: ${n})`;case"CONTRACT_EXPIRED":return`${t}의 계약이 만료되었습니다. (만료일: ${n})`;default:return`${t}의 계약 알림`}}(s,a.customer.name,i,t),customerId:a.customerId,isRead:!1}}),r.push({userId:e.id,type:s,customer:a.customer.name,daysRemaining:i});for(let e of(await c._.user.findMany({where:{customerId:a.customerId,role:"CUSTOMER_ADMIN",isActive:!0},select:{id:!0}})))await c._.notification.create({data:{userId:e.id,type:s,title:d(s,i),message:function(e,t,r,a){let n=a.toLocaleDateString("ko-KR");switch(e){case"CONTRACT_EXPIRY_30":case"CONTRACT_EXPIRY_21":case"CONTRACT_EXPIRY_14":case"CONTRACT_EXPIRY_7":case"CONTRACT_EXPIRY_DAILY":return`${t}과의 계약이 ${r}일 후 만료됩니다. (만료일: ${n})`;case"CONTRACT_EXPIRED":return`${t}과의 계약이 만료되었습니다. (만료일: ${n})`;default:return`${t}과의 계약 알림`}}(s,a.organization.name,i,t),customerId:a.customerId,isRead:!1}}),r.push({userId:e.id,type:s,customer:a.customer.name,daysRemaining:i});u&&await c._.customerOrganization.update({where:{id:a.id},data:{[u]:!0}})}}return o.NextResponse.json({success:!0,message:`${r.length}개의 계약 만료 알림을 생성했습니다.`,notifications:r})}catch(e){return o.NextResponse.json({error:"계약 만료 체크 중 오류가 발생했습니다.",details:e.message},{status:500})}}function d(e,t){switch(e){case"CONTRACT_EXPIRY_30":return"계약 만료 30일 전";case"CONTRACT_EXPIRY_21":return"계약 만료 21일 전";case"CONTRACT_EXPIRY_14":return"계약 만료 14일 전";case"CONTRACT_EXPIRY_7":return"계약 만료 7일 전";case"CONTRACT_EXPIRY_DAILY":return`계약 만료 ${t}일 전`;case"CONTRACT_EXPIRED":return"계약 만료";default:return"계약 알림"}}let R=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/cron/check-contract-expiry/route",pathname:"/api/cron/check-contract-expiry",filename:"route",bundlePath:"app/api/cron/check-contract-expiry/route"},resolvedPagePath:"C:\\Users\\User\\boaz\\frontend\\src\\app\\api\\cron\\check-contract-expiry\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:C,staticGenerationAsyncStorage:T,serverHooks:_}=R,l="/api/cron/check-contract-expiry/route";function p(){return(0,s.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:T})}},20728:(e,t,r)=>{r.d(t,{_:()=>n});let a=require("@prisma/client"),n=global.prisma||new a.PrismaClient({log:["warn","error"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972],()=>r(92609));module.exports=a})();
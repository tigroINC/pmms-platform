"use strict";(()=>{var e={};e.id=5581,e.ids=[5581],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},26299:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>A,patchFetch:()=>E,requestAsyncStorage:()=>N,routeModule:()=>w,serverHooks:()=>h,staticGenerationAsyncStorage:()=>y});var s={};r.r(s),r.d(s,{GET:()=>I,POST:()=>m});var a=r(49303),n=r(88716),o=r(60670),i=r(87070),c=r(75571),d=r(95456),u=r(20728),l=r(20742);async function m(e){try{let t=await (0,c.getServerSession)(d.L);if(!t?.user)return i.NextResponse.json({error:"인증이 필요합니다"},{status:401});let r=t.user,s=await e.json(),a=await (0,l.IK)(r,s);if(!a.allowed)return i.NextResponse.json({error:a.error},{status:403});let n=a.data||s,o=await u._.$transaction(async e=>{let t=n.status||"PENDING",s=await e.communication.create({data:{customerId:n.customerId,measurementId:n.measurementId||null,stackId:n.stackId||null,contactAt:new Date(n.contactAt),channel:n.channel,direction:n.direction,subject:n.subject||null,content:n.content,status:t,priority:n.priority||"NORMAL",createdById:r.id,assignedToId:n.assignedToId||null,contactOrg:n.contactOrg||null,contactPerson:n.contactPerson||null,isShared:void 0===n.isShared||n.isShared},include:{customer:!0,createdBy:{select:{id:!0,name:!0,email:!0}},assignedTo:{select:{id:!0,name:!0,email:!0}}}});return await p(e,s,r),s});return i.NextResponse.json(o,{status:201})}catch(e){return i.NextResponse.json({error:"커뮤니케이션 등록 실패",details:e.message},{status:500})}}async function I(e){try{let t=await (0,c.getServerSession)(d.L);if(!t?.user)return i.NextResponse.json({error:"인증이 필요합니다"},{status:401});let r=t.user,{searchParams:s}=new URL(e.url),a=s.get("view");if("my-tasks"===a){let e=await u._.communication.findMany({where:{assignedToId:r.id,status:"PENDING",isDeleted:!1},include:{customer:{select:{id:!0,name:!0}},createdBy:{select:{id:!0,name:!0}},_count:{select:{notes:!0,attachments:!0}}},orderBy:[{priority:"asc"},{contactAt:"desc"}],take:100});return i.NextResponse.json({tasks:e,summary:{total:e.length,urgent:e.filter(e=>"URGENT"===e.priority).length,high:e.filter(e=>"HIGH"===e.priority).length,normal:e.filter(e=>"NORMAL"===e.priority).length}})}if("client-requests"===a){let e=await u._.communication.findMany({where:{createdBy:{role:{in:["CUSTOMER_ADMIN","CUSTOMER_USER"]}},status:"PENDING",isDeleted:!1},include:{customer:{select:{id:!0,name:!0}},createdBy:{select:{id:!0,name:!0,role:!0}},assignedTo:{select:{id:!0,name:!0}},_count:{select:{notes:!0,attachments:!0}}},orderBy:{contactAt:"desc"},take:100});return i.NextResponse.json({communications:e})}let n=await (0,l.AV)(r),o=s.get("customerId"),m=s.get("status"),I=s.get("channel"),p=s.get("priority"),g=s.get("assignedToId"),R=s.get("search"),w=s.get("startDate"),N=s.get("endDate");o&&(n.customerId=o),m&&(n.status=m),I&&(n.channel=I),p&&(n.priority=p),g&&(n.assignedToId=g),R&&(n.OR=[{subject:{contains:R}},{content:{contains:R}}]),(w||N)&&(n.contactAt={},w&&(n.contactAt.gte=new Date(w)),N&&(n.contactAt.lte=new Date(N)));let y=parseInt(s.get("page")||"1"),h=Math.min(parseInt(s.get("limit")||"50"),100),A=(y-1)*h,[E,O]=await Promise.all([u._.communication.findMany({where:n,select:{id:!0,customerId:!0,contactAt:!0,channel:!0,subject:!0,content:!0,status:!0,priority:!0,contactOrg:!0,contactPerson:!0,isShared:!0,customer:{select:{id:!0,name:!0}},createdBy:{select:{id:!0,name:!0,role:!0}},assignedTo:{select:{id:!0,name:!0}},_count:{select:{notes:!0,attachments:!0}}},orderBy:{contactAt:"desc"},skip:A,take:h}),u._.communication.count({where:n})]);return i.NextResponse.json({data:E,pagination:{page:y,limit:h,total:O,totalPages:Math.ceil(O/h)}})}catch(e){return i.NextResponse.json({error:"목록 조회 실패",details:e.message},{status:500})}}async function p(e,t,r){let s=[];if(!1!==t.isShared){if(t.assignedToId&&t.assignedToId!==r.id&&s.push({userId:t.assignedToId,type:"COMMUNICATION_ASSIGNED",title:"새로운 커뮤니케이션이 배정되었습니다",message:`${t.customer.name}의 커뮤니케이션이 배정되었습니다`,customerId:t.customerId,metadata:JSON.stringify({communicationId:t.id})}),"URGENT"===t.priority&&"PENDING"===t.status){let r=t.assignedToId||await g(e,t.customerId);r&&s.push({userId:r,type:"COMMUNICATION_URGENT",title:"긴급 답변이 필요합니다",message:`${t.customer.name}에서 긴급 답변을 요청했습니다`,customerId:t.customerId,metadata:JSON.stringify({communicationId:t.id})})}if(("CUSTOMER_ADMIN"===r.role||"CUSTOMER_USER"===r.role)&&(await R(e,t.customerId)).forEach(e=>{s.push({userId:e.id,type:"COMMUNICATION_CLIENT_REQUEST",title:"고객사에서 요청사항을 등록했습니다",message:`${t.customer.name} - ${t.subject||t.content.substring(0,50)}`,customerId:t.customerId,metadata:JSON.stringify({communicationId:t.id})})}),("ORG_ADMIN"===r.role||"OPERATOR"===r.role)&&!0===t.isShared){let r=await e.user.findMany({where:{customerId:t.customerId,role:{in:["CUSTOMER_ADMIN","CUSTOMER_USER"]}},select:{id:!0}});r.length>0&&r.forEach(e=>{s.push({userId:e.id,type:"COMMUNICATION_STATUS_CHANGED",title:"새로운 소통 내역이 등록되었습니다",message:`${t.subject||t.content.substring(0,50)}`,customerId:t.customerId,metadata:JSON.stringify({communicationId:t.id})})})}s.length>0&&await e.notification.createMany({data:s})}}async function g(e,t){let r=await e.customerAssignment.findFirst({where:{customerId:t},include:{user:!0}});return r?.userId||null}async function R(e,t){return(await e.customerAssignment.findMany({where:{customerId:t},include:{user:{select:{id:!0,name:!0}}}})).map(e=>e.user)}let w=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/communications/route",pathname:"/api/communications",filename:"route",bundlePath:"app/api/communications/route"},resolvedPagePath:"C:\\Users\\User\\boaz\\frontend\\src\\app\\api\\communications\\route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:N,staticGenerationAsyncStorage:y,serverHooks:h}=w,A="/api/communications/route";function E(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:y})}},95456:(e,t,r)=>{r.d(t,{L:()=>i});var s=r(53797),a=r(13539),n=r(20728),o=r(98691);let i={adapter:(0,a.N)(n._),providers:[(0,s.Z)({name:"credentials",credentials:{email:{label:"이메일",type:"email"},password:{label:"비밀번호",type:"password"}},async authorize(e){if(!e?.email||!e?.password)throw Error("이메일과 비밀번호를 입력해주세요.");let t=await n._.user.findUnique({where:{email:e.email},include:{organization:!0,customer:!0}});if(!t)throw Error("등록되지 않은 이메일입니다.");if("APPROVED"!==t.status)throw Error("승인 대기 중이거나 거부된 계정입니다.");if(!t.isActive)throw Error("비활성화된 계정입니다.");if(!await o.ZP.compare(e.password,t.password))throw Error("비밀번호가 일치하지 않습니다.");return await n._.user.update({where:{id:t.id},data:{lastLoginAt:new Date,loginCount:{increment:1}}}),await n._.activityLog.create({data:{userId:t.id,action:"LOGIN",ipAddress:null,userAgent:null}}),{id:t.id,email:t.email,name:t.name,role:t.role,organizationId:t.organizationId,customerId:t.customerId,customerName:t.customer?.name||null,status:t.status,passwordResetRequired:t.passwordResetRequired}}})],callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.role=t.role,e.organizationId=t.organizationId,e.customerId=t.customerId,e.customerName=t.customerName,e.status=t.status,e.passwordResetRequired=t.passwordResetRequired),e),session:async({session:e,token:t})=>(e.user&&(e.user.id=t.id,e.user.role=t.role,e.user.organizationId=t.organizationId,e.user.customerId=t.customerId,e.user.customerName=t.customerName,e.user.status=t.status,e.user.passwordResetRequired=t.passwordResetRequired),e)},pages:{signIn:"/login",error:"/login"},session:{strategy:"jwt",maxAge:86400},secret:process.env.NEXTAUTH_SECRET}},20742:(e,t,r)=>{r.d(t,{AV:()=>d,IK:()=>a,RA:()=>o,St:()=>n,dH:()=>i,hZ:()=>c});var s=r(20728);async function a(e,t){if("SUPER_ADMIN"===e.role)return{allowed:!0};if("CUSTOMER_ADMIN"===e.role||"CUSTOMER_USER"===e.role)return e.customerId?{allowed:!0,data:{...t,customerId:e.customerId,direction:"OUTBOUND",createdById:e.id}}:{allowed:!1,error:"소속 고객사 정보가 없습니다"};if("ORG_ADMIN"===e.role||"OPERATOR"===e.role){let r=await s._.user.findUnique({where:{id:e.id},include:{organization:{select:{name:!0}}}});return"ORG_ADMIN"===e.role?{allowed:!0,data:{...t,direction:t.direction||"INBOUND",contactOrg:r?.organization?.name||t.contactOrg}}:await s._.customerAssignment.findFirst({where:{userId:e.id,customerId:t.customerId}})?{allowed:!0,data:{...t,direction:t.direction||"INBOUND",contactOrg:r?.organization?.name||t.contactOrg}}:{allowed:!1,error:"담당 고객사가 아닙니다"}}return{allowed:!1,error:"권한이 없습니다"}}async function n(e,t){return"SUPER_ADMIN"===e.role||("CUSTOMER_ADMIN"===e.role||"CUSTOMER_USER"===e.role?t.customerId===e.customerId:"ORG_ADMIN"===e.role||"OPERATOR"===e.role&&!!await s._.customerAssignment.findFirst({where:{userId:e.id,customerId:t.customerId}}))}async function o(e,t){return"SUPER_ADMIN"===e.role||"CUSTOMER_ADMIN"!==e.role&&"CUSTOMER_USER"!==e.role&&t.createdById===e.id&&!((Date.now()-t.createdAt.getTime())/36e5>24)}async function i(e,t){return"SUPER_ADMIN"===e.role||"CUSTOMER_ADMIN"!==e.role&&"CUSTOMER_USER"!==e.role&&t.createdById===e.id&&(Date.now()-t.createdAt.getTime())/36e5<=24}async function c(e,t){return"SUPER_ADMIN"===e.role||"CUSTOMER_ADMIN"!==e.role&&"CUSTOMER_USER"!==e.role&&(t.createdById===e.id||t.assignedToId===e.id)}async function d(e){return"SUPER_ADMIN"===e.role?{isDeleted:!1}:"CUSTOMER_ADMIN"===e.role||"CUSTOMER_USER"===e.role?{customerId:e.customerId,isShared:!0,isDeleted:!1}:"ORG_ADMIN"===e.role?{isDeleted:!1}:"OPERATOR"===e.role?{customerId:{in:(await s._.customerAssignment.findMany({where:{userId:e.id},select:{customerId:!0}})).map(e=>e.customerId)},isDeleted:!1}:{id:"NONE"}}},20728:(e,t,r)=>{r.d(t,{_:()=>a});let s=require("@prisma/client"),a=global.prisma||new s.PrismaClient({log:["warn","error"]})}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,5972,8691,9637],()=>r(26299));module.exports=s})();
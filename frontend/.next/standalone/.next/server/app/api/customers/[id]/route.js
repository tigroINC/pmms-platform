"use strict";(()=>{var e={};e.id=7429,e.ids=[7429],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},26980:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>g,patchFetch:()=>x,requestAsyncStorage:()=>w,routeModule:()=>h,serverHooks:()=>v,staticGenerationAsyncStorage:()=>y});var r={};s.r(r),s.d(r,{DELETE:()=>l,GET:()=>p,PATCH:()=>m});var a=s(49303),o=s(88716),i=s(60670),n=s(87070),u=s(75571),d=s(95456),c=s(20728);async function p(e,{params:t}){try{let e=await (0,u.getServerSession)(d.L);if(!e)return n.NextResponse.json({error:"인증이 필요합니다."},{status:401});let s=e.user.role,r=e.user.customerId,a=("CUSTOMER_ADMIN"===s||"CUSTOMER_USER"===s)&&r===t.id;if("SUPER_ADMIN"!==s&&!a)return n.NextResponse.json({error:"권한이 없습니다."},{status:403});let o=await c._.customer.findUnique({where:{id:t.id},include:{users:{select:{id:!0,email:!0,name:!0,phone:!0,role:!0,status:!0,isActive:!0,department:!0,position:!0,createdAt:!0}},stacks:{select:{id:!0,name:!0,code:!0,isActive:!0}},_count:{select:{users:!0,stacks:!0,measurements:!0}}}});if(!o)return n.NextResponse.json({error:"고객회사를 찾을 수 없습니다."},{status:404});return n.NextResponse.json({customer:o})}catch(e){return n.NextResponse.json({error:"고객회사 조회 중 오류가 발생했습니다."},{status:500})}}async function m(e,{params:t}){let{id:s}=t,r=await e.json();try{if(r.name&&await c._.customer.findFirst({where:{name:r.name,id:{not:s}}}))return n.NextResponse.json({error:"이미 존재하는 고객사명입니다"},{status:400});if("approve"===r.action){let e=await c._.customer.update({where:{id:s},data:{isActive:!0}});return n.NextResponse.json({message:"고객회사가 승인되었습니다.",customer:e})}if("reject"===r.action){let e=await c._.customer.update({where:{id:s},data:{isActive:!1}});return n.NextResponse.json({message:"고객회사가 거부되었습니다.",customer:e})}let e=await c._.customer.findUnique({where:{id:s}}),t={},a=[];void 0!==r.name&&r.name!==e?.name&&(t.name=r.name,a.push(`회사명: ${e?.name} → ${r.name}`)),void 0!==r.businessNumber&&r.businessNumber!==e?.businessNumber&&(t.businessNumber=r.businessNumber,a.push(`사업자번호: ${e?.businessNumber||"없음"} → ${r.businessNumber}`)),void 0!==r.corporateNumber&&r.corporateNumber!==e?.corporateNumber&&(t.corporateNumber=r.corporateNumber,a.push(`법인등록번호: ${e?.corporateNumber||"없음"} → ${r.corporateNumber}`)),void 0!==r.address&&r.address!==e?.address&&(t.address=r.address,a.push(`주소: ${e?.address||"없음"} → ${r.address}`)),void 0!==r.representative&&r.representative!==e?.representative&&(t.representative=r.representative,a.push(`대표자: ${e?.representative||"없음"} → ${r.representative}`)),void 0!==r.businessType&&r.businessType!==e?.businessType&&(t.businessType=r.businessType,a.push(`업태: ${e?.businessType||"없음"} → ${r.businessType}`)),void 0!==r.industry&&r.industry!==e?.industry&&(t.industry=r.industry,a.push(`업종: ${e?.industry||"없음"} → ${r.industry}`)),void 0!==r.siteType&&r.siteType!==e?.siteType&&(t.siteType=r.siteType,a.push(`사업장: ${e?.siteType||"없음"} → ${r.siteType}`)),void 0!==r.siteCategory&&r.siteCategory!==e?.siteCategory&&(t.siteCategory=r.siteCategory,a.push(`사업장종별: ${e?.siteCategory||"없음"} → ${r.siteCategory}`)),void 0!==r.phone&&r.phone!==e?.phone&&(t.phone=r.phone,a.push(`전화번호: ${e?.phone||"없음"} → ${r.phone}`)),void 0!==r.email&&r.email!==e?.email&&(t.email=r.email,a.push(`이메일: ${e?.email||"없음"} → ${r.email}`)),void 0!==r.contactPerson&&r.contactPerson!==e?.contactPerson&&(t.contactPerson=r.contactPerson,a.push(`담당자: ${e?.contactPerson||"없음"} → ${r.contactPerson}`)),void 0!==r.contactPhone&&r.contactPhone!==e?.contactPhone&&(t.contactPhone=r.contactPhone,a.push(`담당자연락처: ${e?.contactPhone||"없음"} → ${r.contactPhone}`)),void 0!==r.isActive&&r.isActive!==e?.isActive&&(t.isActive=r.isActive,a.push(`활성상태: ${e?.isActive?"활성":"비활성"} → ${r.isActive?"활성":"비활성"}`)),t.isVerified=!1,t.lastModifiedBy="ORG",t.lastModifiedAt=new Date;let o=await c._.customer.update({where:{id:s},data:t}),i=await c._.user.findMany({where:{customerId:s,role:"CUSTOMER_ADMIN"},select:{id:!0}}),u=a.length>0?`환경측정기업이 조직 정보를 수정했습니다.
변경 내역: ${a.join(", ")}`:"환경측정기업이 조직 정보를 수정했습니다.";for(let e of i)await c._.notification.create({data:{userId:e.id,type:"CUSTOMER_INFO_UPDATED_BY_ORG",title:"조직 정보 수정",message:u,customerId:s}});return n.NextResponse.json({message:"고객회사 정보가 수정되었습니다.",customer:o})}catch(e){return n.NextResponse.json({error:e.message||"업데이트 실패"},{status:500})}}async function l(e,{params:t}){let{id:s}=t;try{if(await c._.measurement.count({where:{customerId:s}})>0)return n.NextResponse.json({error:"측정 기록이 있는 고객사는 삭제할 수 없습니다"},{status:400});for(let e of(await c._.stack.findMany({where:{customerId:s},select:{id:!0}})))await c._.stackAlias.deleteMany({where:{stackId:e.id}});return await c._.stack.deleteMany({where:{customerId:s}}),await c._.customer.delete({where:{id:s}}),n.NextResponse.json({ok:!0})}catch(e){return n.NextResponse.json({error:"삭제 실패"},{status:500})}}let h=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/customers/[id]/route",pathname:"/api/customers/[id]",filename:"route",bundlePath:"app/api/customers/[id]/route"},resolvedPagePath:"C:\\Users\\User\\boaz\\frontend\\src\\app\\api\\customers\\[id]\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:w,staticGenerationAsyncStorage:y,serverHooks:v}=h,g="/api/customers/[id]/route";function x(){return(0,i.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:y})}},95456:(e,t,s)=>{s.d(t,{L:()=>n});var r=s(53797),a=s(13539),o=s(20728),i=s(98691);let n={adapter:(0,a.N)(o._),providers:[(0,r.Z)({name:"credentials",credentials:{email:{label:"이메일",type:"email"},password:{label:"비밀번호",type:"password"}},async authorize(e){if(!e?.email||!e?.password)throw Error("이메일과 비밀번호를 입력해주세요.");let t=await o._.user.findUnique({where:{email:e.email},include:{organization:!0,customer:!0}});if(!t)throw Error("등록되지 않은 이메일입니다.");if("APPROVED"!==t.status)throw Error("승인 대기 중이거나 거부된 계정입니다.");if(!t.isActive)throw Error("비활성화된 계정입니다.");if(!await i.ZP.compare(e.password,t.password))throw Error("비밀번호가 일치하지 않습니다.");return await o._.user.update({where:{id:t.id},data:{lastLoginAt:new Date,loginCount:{increment:1}}}),await o._.activityLog.create({data:{userId:t.id,action:"LOGIN",ipAddress:null,userAgent:null}}),{id:t.id,email:t.email,name:t.name,role:t.role,organizationId:t.organizationId,customerId:t.customerId,customerName:t.customer?.name||null,status:t.status,passwordResetRequired:t.passwordResetRequired}}})],callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.role=t.role,e.organizationId=t.organizationId,e.customerId=t.customerId,e.customerName=t.customerName,e.status=t.status,e.passwordResetRequired=t.passwordResetRequired),e),session:async({session:e,token:t})=>(e.user&&(e.user.id=t.id,e.user.role=t.role,e.user.organizationId=t.organizationId,e.user.customerId=t.customerId,e.user.customerName=t.customerName,e.user.status=t.status,e.user.passwordResetRequired=t.passwordResetRequired),e)},pages:{signIn:"/login",error:"/login"},session:{strategy:"jwt",maxAge:86400},secret:process.env.NEXTAUTH_SECRET}},20728:(e,t,s)=>{s.d(t,{_:()=>a});let r=require("@prisma/client"),a=global.prisma||new r.PrismaClient({log:["warn","error"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[8948,5972,8691,9637],()=>s(26980));module.exports=r})();
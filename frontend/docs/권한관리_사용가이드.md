# 세분화된 권한 관리 시스템 사용 가이드

## 📋 개요

환경측정기업별로 다양한 가격 구조와 서비스 이용 정책을 적용할 수 있도록 세분화된 권한 관리 시스템이 구현되었습니다.

---

## 🎯 주요 기능

### 1. 탭 레벨 권한
- `customer.tab.all` - 전체탭 보기
- `customer.tab.internal` - 내부탭 보기
- `customer.tab.connected` - 연결탭 보기
- `customer.tab.search` - 검색탭 보기

### 2. 기능 레벨 권한
- `customer.view` - 고객사 조회
- `customer.create` - 고객사 등록
- `customer.update` - 고객사 수정
- `customer.delete` - 고객사 삭제
- `customer.activate` - 활성화/비활성화

### 3. 고급 기능 권한
- `customer.search` - 검색 기능
- `customer.filter` - 필터 기능
- `customer.bulk_upload` - 일괄업로드
- `customer.export` - Excel 내보내기
- `customer.invite` - 고객사 초대

---

## 🔧 오프라인 전용 기업 설정 방법

### Step 1: 역할 생성
1. `/org/settings/roles` 페이지 접속
2. "역할 생성" 버튼 클릭
3. 역할 정보 입력:
   - **역할 이름**: "오프라인 전용"
   - **설명**: "고객에게 정보를 온라인 오픈하지 않고 자체적으로만 사용하는 기업"

### Step 2: 권한 선택
**고객사 관리** 카테고리에서 다음 권한만 체크:
- ✅ 전체탭 보기 (`customer.tab.all`)
- ✅ 고객사 조회 (`customer.view`)
- ✅ 일괄업로드 (`customer.bulk_upload`)
- ✅ Excel 내보내기 (`customer.export`)

**체크 해제할 권한** (연결 관련 기능 차단):
- ❌ 내부탭 보기
- ❌ 연결탭 보기
- ❌ 검색탭 보기
- ❌ 고객사 등록
- ❌ 고객사 수정
- ❌ 고객사 초대
- ❌ 검색 기능
- ❌ 필터 기능

### Step 3: 사용자에게 역할 할당
1. `/org/settings/users` 페이지에서 사용자 선택
2. "역할 변경" 클릭
3. "오프라인 전용" 역할 선택
4. 저장

---

## 💡 다양한 프로필 예시

### 1. 데이터 입력 전용
```
✅ 전체탭 보기
✅ 고객사 조회
✅ 측정 데이터 입력
✅ 측정 데이터 조회
❌ 고객사 등록/수정
❌ 보고서 생성
```

### 2. 보고서 조회 전용
```
✅ 전체탭 보기
✅ 고객사 조회
✅ 측정 데이터 조회
✅ 보고서 조회
❌ 데이터 입력/수정
❌ 고객사 관리
```

### 3. 현장 책임자
```
✅ 모든 탭 보기
✅ 고객사 조회/수정
✅ 측정 데이터 입력/수정
✅ 보고서 생성
✅ 일괄업로드
❌ 고객사 삭제
❌ 사용자 관리
```

---

## 🛠️ 개발자 가이드

### 새로운 페이지에 권한 체크 적용하기

```typescript
import { usePermissions } from "@/hooks/usePermissions";

export default function MyPage() {
  const { hasPermission, loading } = usePermissions();

  // 로딩 중 처리
  if (loading) return <div>로딩 중...</div>;

  return (
    <>
      {/* 탭 권한 체크 */}
      {hasPermission('customer.tab.all') && (
        <TabButton>전체</TabButton>
      )}

      {/* 버튼 권한 체크 */}
      {hasPermission('customer.create') && (
        <Button>신규 추가</Button>
      )}

      {/* 여러 권한 중 하나라도 있으면 */}
      {hasAnyPermission(['customer.create', 'customer.update']) && (
        <ActionPanel />
      )}
    </>
  );
}
```

### 새로운 권한 코드 추가하기

1. `src/components/modals/CreateRoleModal.tsx`의 `PERMISSIONS` 배열에 추가
2. `src/app/org/settings/roles/[id]/page.tsx`의 `PERMISSIONS` 배열에 추가
3. UI 컴포넌트에서 `hasPermission()` 사용

---

## 📊 권한 우선순위

1. **사용자 개별 권한** (최우선)
2. **커스텀 역할 권한**
3. **역할 템플릿 기본 권한**
4. **시스템 기본 역할** (fallback)

---

## ⚠️ 주의사항

1. **SUPER_ADMIN**은 모든 권한을 가지며 제한할 수 없습니다.
2. 권한 변경 후 **로그아웃/재로그인** 필요 (향후 실시간 반영 예정)
3. 와일드카드(`customer.*`)는 해당 카테고리의 모든 권한을 포함합니다.
4. 역할 삭제는 해당 역할을 사용하는 사용자가 없을 때만 가능합니다.

---

## 🔍 문제 해결

### Q: 권한을 설정했는데 화면에 반영이 안 돼요
A: 로그아웃 후 다시 로그인하세요. (권한 캐싱 때문)

### Q: 특정 탭만 보이게 하고 싶어요
A: 해당 탭의 권한만 체크하고 나머지는 해제하세요.

### Q: 오프라인 전용 기업이 실수로 연결 버튼을 누르면?
A: 연결 관련 권한이 없으면 API에서 차단됩니다.

---

## 📞 문의

권한 관리 관련 문의사항은 시스템 관리자에게 연락하세요.
